<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運動島 - 全方位管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script id="liff-sdk" charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="backend.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import {
            Users, Calendar, ClipboardList, Search, UserPlus, CheckCircle, Clock, MapPin,
            Tag as TagIcon, Filter, Navigation, Plus, EyeOff, Eye, Trash2, AlertCircle,
            RotateCcw, Archive, X, User, Phone, Home, Cake, Activity, Info, CreditCard,
            Check, CalendarDays, Calculator, Sun, Moon, Sunset, ListChecks, Backpack,
            Map, ChevronRight, Save, FileText, CalendarPlus, ArrowRight, Settings,
            Repeat, ToggleLeft, ToggleRight, Hash, Pencil, Palmtree, School, HeartPulse,
            GraduationCap, Zap, FileUp, Download, DollarSign, ClipboardCheck, ShieldCheck
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- Shared Constants ---
        // ★ 請在此填入您的 Google Apps Script 網頁應用程式網址 (若部署在 GitHub) ★
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzPkZY0cG0Z4vNqs2c32QbbP9tiFbwJzKeo8Ru5lz6W-lteW4ety_7BZTHpbiskWM7Ogw/exec";

        // --- API Helper ---
        const callApi = async (action, payload = {}) => {
            return new Promise((resolve, reject) => {
                // 情境 A: 在 Google Apps Script 環境下 (內嵌)
                if (typeof google !== 'undefined' && google.script) {
                    google.script.run
                        .withSuccessHandler(res => resolve(res))
                        .withFailureHandler(err => reject(err))
                    [action](payload); // 動態呼叫後端函式
                }
                // 情境 B: 在 GitHub Pages (外部呼叫)
                else {
                    if (!GAS_API_URL || GAS_API_URL.includes("AKfycbx...")) {
                        console.warn("尚未設定 GAS_API_URL，無法連線後端");
                        if (action === 'apiLogin') resolve({ status: 'success', isAdmin: true, message: 'Dev Mode' }); // 開發用
                        else resolve({ status: 'error', message: 'API URL not set' });
                        return;
                    }

                    fetch(GAS_API_URL, {
                        method: 'POST',
                        mode: 'cors', // 關鍵
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8', // 避開 preflight
                        },
                        body: JSON.stringify({ action: action, payload: payload })
                    })
                        .then(res => res.json())
                        .then(data => {
                            // 後端回傳格式為 { status: 'success', data: ... }
                            // 但如果是 apiLogin, code111.gs 回傳的是平坦物件，這裡做個相容
                            if (data.status === 'success' && data.data) resolve(data.data);
                            else resolve(data);
                        })
                        .catch(err => reject(err));
                }
            });
        };

        const INITIAL_COURSES = [
            {
                id: 'camp1',
                location: '新竹迪卡儂',
                name: '2026 冬令營 - 第一梯次',
                capacity: 10,
                current: 8,
                showCapacity: true,
                fullPrice: 7500,
                ageGroup: '大班～國小六年級',
                isHidden: false,
                dates: ['2026/1/26 (一)', '2026/1/27 (二)', '2026/1/28 (三)', '2026/1/29 (四)', '2026/1/30 (五)'],
                image: '',
                googleFormUrl: 'https://docs.google.com/forms/u/0/',
                pricingPlans: [{ name: '全日營', price: 7500 }],
                duration: '09:00 - 17:00'
            }
        ];

        const INITIAL_MEMBERS = [];

        // --- Admin View Component ---
        const AdminView = ({ setView, userStatus }) => {
            // Verify Admin Status
            useEffect(() => {
                if (userStatus && userStatus.userId && !userStatus.isAdmin) {
                    alert('您沒有管理員權限！');
                    setView('user');
                }
            }, [userStatus]);

            const [courses, setCourses] = useState(() => JSON.parse(localStorage.getItem('si_courses_v2')) || INITIAL_COURSES);
            const [members, setMembers] = useState(() => JSON.parse(localStorage.getItem('si_members')) || INITIAL_MEMBERS);
            const [bookings, setBookings] = useState(() => JSON.parse(localStorage.getItem('si_bookings')) || []);

            useEffect(() => {
                const fetchData = async () => {
                    if (!userStatus.userId) return;
                    setIsLoading(true);
                    try {
                        const data = await callApi('getSystemData', { userId: userStatus.userId });
                        if (data) {
                            if (data.courses) setCourses(data.courses);
                            if (data.members) setMembers(data.members);
                            if (data.registrations) {
                                setBookings(data.registrations.map(r => ({
                                    id: r.id,
                                    memberId: r.memberId,
                                    courseId: r.courseId,
                                    status: r.status,
                                    date: r.createdAt ? new Date(r.createdAt).toLocaleDateString('zh-TW') : '',
                                    amount: r.amount,
                                    last5Digits: r.last5Digits,
                                    attendance: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.status }), {}),
                                    attendanceRemarks: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.note }), {}),
                                    attendDates: r.selectedDates
                                })));
                            }
                        }
                    } catch (e) {
                        console.error('Fetch admin system data failed:', e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, [userStatus.userId]);

            useEffect(() => localStorage.setItem('si_courses_v2', JSON.stringify(courses)), [courses]);
            useEffect(() => localStorage.setItem('si_members', JSON.stringify(members)), [members]);
            useEffect(() => localStorage.setItem('si_bookings', JSON.stringify(bookings)), [bookings]);

            const [tab, setTab] = useState('orders');
            const [attendanceSearchTerm, setAttendanceSearchTerm] = useState('');
            const [adminSearch, setAdminSearch] = useState('');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [addCourseModal, setAddCourseModal] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showHiddenCourses, setShowHiddenCourses] = useState(false);
            const [courseSearch, setCourseSearch] = useState('');

            const [newCourseData, setNewCourseData] = useState({
                name: '', location: '新竹迪卡儂', address: '新竹市東區慈雲路126號', pickupPoint: '',
                description: '', ageGroup: '大班～國小六年級',
                dates: [], dateInput: '', fullPrice: 7500, halfPrice: 4000, themeColor: '#10b981',
                capacity: 10, showCapacity: true,
                earlyBirdPrice: 0, earlyBirdDeadline: '',
                activityTime: '09:00 - 17:00', pickUpTime: '17:00 - 18:00',
                image: '',
                googleFormUrl: '',
                googleSheetUrl: '',
                enableDateSelection: true,
                pricingPlans: [],
                equipmentFee: { enabled: false, price: 1000, description: '' }
            });
            const [isLoading, setIsLoading] = useState(false);
            const [batches, setBatches] = useState([]);

            const getMemberName = (id) => members.find(m => m.id === id)?.name || '未知會員';
            const getCourseName = (id) => courses.find(c => c.id === id)?.name || '未知課程';
            const formatDateDisplay = (dateStr) => { try { const date = new Date(dateStr); const days = ['日', '一', '二', '三', '四', '五', '六']; return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} (${days[date.getDay()]})`; } catch (e) { return dateStr; } };

            const handleAddNewBatch = () => setBatches([...batches, { name: `第 ${batches.length + 1} 梯次`, dates: [], dateInput: '' }]);
            const handleDeleteBatch = (idx) => setBatches(batches.filter((_, i) => i !== idx));
            const handleAddBatchDate = (idx, date) => {
                if (!date) return;
                const formattedDate = formatDateDisplay(date);
                setBatches(batches.map((b, i) => i === idx ? { ...b, dates: [...b.dates, formattedDate].sort(), dateInput: '' } : b));
            };
            const handleAddConsecutiveDays = (idx, startDate, count = 5) => {
                if (!startDate) return;
                const newDates = [];
                const dateObj = new Date(startDate);
                for (let i = 0; i < count; i++) {
                    const d = new Date(dateObj);
                    d.setDate(dateObj.getDate() + i);
                    newDates.push(formatDateDisplay(d.toISOString().split('T')[0]));
                }
                setBatches(batches.map((b, i) => {
                    if (i !== idx) return b;
                    return { ...b, dates: Array.from(new Set([...b.dates, ...newDates])).sort(), dateInput: '' };
                }));
            };
            const handleRemoveBatchDate = (idx, date) => setBatches(batches.map((b, i) => i === idx ? { ...b, dates: b.dates.filter(d => d !== date) } : b));
            const handleUpdateBatchName = (idx, name) => setBatches(batches.map((b, i) => i === idx ? { ...b, name } : b));



            const onEditCourse = (course) => {
                if (!course || !course.id) {
                    setIsEditing(false);
                    setNewCourseData({
                        name: '', location: '', ageGroup: '', duration: '', fullPrice: 0,
                        image: '',
                        googleFormUrl: '', dates: [], dateInput: '', capacity: 10, showCapacity: true, themeColor: '#10b981',
                        description: '', address: '', pickupPoint: '', halfPrice: 0
                    });
                    setBatches([{ name: '第一梯次', dates: [], dateInput: '' }]);
                } else {
                    setIsEditing(true);
                    setEditingId(course.id);
                    setNewCourseData({
                        name: course.name, location: course.location, address: course.address || '', pickupPoint: course.pickupPoint || '',
                        description: course.description || '', ageGroup: course.ageGroup,
                        dates: course.dates || [], dateInput: '',
                        fullPrice: course.fullPrice, halfPrice: course.halfPrice || 0,
                        earlyBirdPrice: course.earlyBirdPrice || 0, earlyBirdDeadline: course.earlyBirdDeadline || '',
                        duration: course.time || course.duration,
                        image: course.image, googleFormUrl: course.googleFormUrl || '', googleSheetUrl: course.googleSheetUrl || '',
                        capacity: course.capacity || 10, showCapacity: course.showCapacity !== false,
                        allowWaitlist: course.allowWaitlist, registrationDeadline: course.registrationDeadline,
                        themeColor: course.themeColor || '#10b981'
                    });
                    if (course.dates && course.dates.length > 0) {
                        setBatches([{ name: '原梯次日期', dates: course.dates || [], dateInput: '' }]);
                    } else {
                        setBatches([{ name: '第一梯次', dates: [], dateInput: '' }]);
                    }

                }
                setAddCourseModal(true);
            };


            const handleSaveCourse = () => {
                // 簡單驗證
                if (!newCourseData.name) { alert('請輸入課程名稱'); setIsLoading(false); return; }
                if (!newCourseData.fullPrice) { alert('請輸入價格'); setIsLoading(false); return; }

                setIsLoading(true); // 開啟讀取中遮罩

                const hasValidBatches = batches.some(batch => batch.dates.length > 0);
                if (!newCourseData.name || !hasValidBatches) {
                    alert('請輸入梯次名稱並至少選擇一個日期');
                    setIsLoading(false);
                    return;
                }
                const allBatchDates = Array.from(new Set(batches.flatMap(b => b.dates))).sort();

                const coursePayload = {
                    id: isEditing ? editingId : `camp-new-${Date.now()}`,
                    location: newCourseData.location, name: newCourseData.name,
                    time: newCourseData.duration, capacity: parseInt(newCourseData.capacity || 9999),
                    current: isEditing ? courses.find(c => c.id === editingId).current : 0,
                    showCapacity: newCourseData.showCapacity !== false, fullPrice: parseInt(newCourseData.fullPrice),
                    earlyBirdPrice: parseInt(newCourseData.earlyBirdPrice || 0), earlyBirdDeadline: newCourseData.earlyBirdDeadline,
                    ageGroup: newCourseData.ageGroup, isHidden: false, dates: allBatchDates,
                    image: newCourseData.image, googleFormUrl: newCourseData.googleFormUrl, googleSheetUrl: newCourseData.googleSheetUrl,
                    allowWaitlist: newCourseData.allowWaitlist, registrationDeadline: newCourseData.registrationDeadline,
                    themeColor: newCourseData.themeColor,
                    description: newCourseData.description, address: newCourseData.address, pickupPoint: newCourseData.pickupPoint, halfPrice: newCourseData.halfPrice,

                    // 重要: 傳遞 userId 以便後端記錄或驗證
                    userId: userStatus.userId,
                    action: isEditing ? 'apiUpdateCourse' : 'apiAddCourse'
                };

                const action = isEditing ? 'apiUpdateCourse' : 'apiAddCourse';

                // 統一呼叫後端 API (包含建立表單邏輯)
                // callApi 內部會自動判斷是 GAS 環境還是 Web 環境
                callApi(action, coursePayload)
                    .then(data => {
                        // 後端回傳的是最新的系統資料 (getSystemData)
                        if (data && data.courses) {
                            setCourses(data.courses);
                            // 如果有回傳 categories 或其他資料也可在此更新
                            // setMembers(data.members); 
                        } else {
                            // Fallback: 如果後端只回傳單一課程或格式不同 (目前後端是回傳 getSystemData)
                            // 這裡假設後端回傳正確，若無則手動更新 local state (較不建議，因為沒有 Form URL)
                            console.warn('Backend did not return full system data, refetching...');
                            // 可以在此呼叫 reloading 邏輯，或暫時只更新 local
                        }

                        setAddCourseModal(false);
                        setIsEditing(false);
                        setNewCourseData({});

                        setBatches([{ name: '第一梯次', dates: [], dateInput: '' }]);

                        alert(isEditing ? '更新成功！' : '建立成功！');
                        setIsLoading(false);
                    })
                    .catch(err => {
                        console.error('Save course failed:', err);
                        alert('儲存失敗: ' + err + '\n請檢查網路或後端部署狀態。');
                        setIsLoading(false);
                    });
            };

            const stats = {
                paid: bookings.filter(b => b.status === '已付款').length,
                unverified: bookings.filter(b => b.status === '待核對').length,
                waitlist: bookings.filter(b => b.status === '候補').length,
            };

            return (
                <div className="min-h-screen bg-slate-100 pb-20 font-sans text-slate-900">
                    <div className="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
                        <h2 className="font-black text-lg flex items-center gap-2"><Settings className="w-5 h-5" /> 後台管理系統</h2>
                        <button onClick={() => setView('user')} className="text-xs font-bold bg-slate-700 px-3 py-1.5 rounded-lg hover:bg-slate-600 no-underline text-white">回前台</button>
                    </div>
                    {/* Admin Mobile Bottom Nav */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-2 z-50 flex justify-around items-center pb-safe">
                        {[{ id: 'orders', label: '訂單', icon: ClipboardList }, { id: 'courses', label: '課程', icon: Calendar }, { id: 'payments', label: '對帳', icon: CreditCard }, { id: 'attendance', label: '點名', icon: ListChecks }].map(t => (
                            <button key={t.id} onClick={() => setTab(t.id)} className={`flex flex-col items-center justify-center p-2 rounded-xl w-14 transition-all ${tab === t.id ? 'text-cyan-600' : 'text-slate-400'}`}>
                                <t.icon className={`w-6 h-6 mb-1 ${tab === t.id ? 'fill-current' : ''}`} />
                                <span className="text-[10px] font-black">{t.label}</span>
                            </button>
                        ))}
                        <button onClick={() => setView('user')} className="flex flex-col items-center justify-center p-2 rounded-xl w-14 text-slate-400">
                            <RotateCcw className="w-6 h-6 mb-1" />
                            <span className="text-[10px] font-black">前台</span>
                        </button>
                    </div>

                    <div className="bg-white border-b border-slate-200 px-4 overflow-x-auto hidden md:block">
                        <div className="flex gap-6 min-w-max">
                            {[{ id: 'orders', label: '訂單管理', icon: ClipboardList }, { id: 'courses', label: '課程/梯次', icon: Calendar }, { id: 'payments', label: '付款對帳', icon: CreditCard }, { id: 'attendance', label: '點名系統', icon: ListChecks }].map(t => (
                                <button key={t.id} onClick={() => setTab(t.id)} className={`py-4 text-sm font-black border-b-2 flex items-center gap-2 transition-colors ${tab === t.id ? 'border-cyan-600 text-cyan-600' : 'border-transparent text-slate-400 hover:text-slate-600'}`}>
                                    <t.icon className="w-4 h-4" /> {t.label}
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="p-4 md:p-6 max-w-7xl mx-auto space-y-6">
                        {tab === 'orders' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col items-center"><span className="text-slate-400 text-xs font-black uppercase">今日繳費人數</span><span className="text-3xl font-black text-emerald-600 mt-2">{stats.paid}</span></div>
                                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col items-center cursor-pointer hover:border-orange-300" onClick={() => setTab('payments')}><span className="text-slate-400 text-xs font-black uppercase">待對帳款項</span><span className="text-3xl font-black text-orange-500 mt-2">{stats.unverified}</span></div>
                                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col items-center"><span className="text-slate-400 text-xs font-black uppercase">候補人數</span><span className="text-3xl font-black text-slate-600 mt-2">{stats.waitlist}</span></div>
                                </div>
                                <div className="bg-white p-6 rounded-2xl border border-slate-200 space-y-4 text-left">
                                    <div className="flex flex-col md:flex-row gap-4 items-center justify-between">
                                        <div className="flex gap-2 w-full md:w-auto flex-1"><Search className="w-5 h-5 text-slate-400 m-2" /><input className="flex-1 bg-transparent text-sm font-bold outline-none" placeholder="搜尋訂單編號、姓名..." value={adminSearch} onChange={e => setAdminSearch(e.target.value)} /></div>
                                        <div className="flex gap-2 shrink-0">
                                            <button onClick={() => { const csvData = [['訂單編號', '日期', '學員', '梯次', '金額', '狀態', '末五碼']]; bookings.forEach(b => csvData.push([b.id, b.date, getMemberName(b.memberId), getCourseName(b.courseId), b.amount, b.status, b.last5Digits || ''])); const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + csvData.map(e => e.join(",")).join("\n"); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", "Orders.csv"); document.body.appendChild(link); link.click(); }} className="px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-cyan-50 hover:text-cyan-600"><Download className="w-3 h-3" /> 匯出訂單</button>
                                        </div>
                                    </div>
                                    <div className="hidden md:block overflow-x-auto"><table className="w-full text-left border-collapse"><thead><tr className="border-b border-slate-100 text-xs font-black text-slate-400 uppercase tracking-wider"><th className="p-3">編號</th><th className="p-3">日期</th><th className="p-3">學員</th><th className="p-3">梯次</th><th className="p-3">金額</th><th className="p-3">狀態</th><th className="p-3">操作</th></tr></thead><tbody className="text-sm font-bold text-slate-600">{bookings.filter(b => b.id.includes(adminSearch) || getMemberName(b.memberId).includes(adminSearch)).map(b => (<tr key={b.id} className="border-b border-slate-50 hover:bg-slate-50"><td className="p-3 font-mono text-xs text-slate-400">{b.id.slice(-6)}</td><td className="p-3">{b.date}</td><td className="p-3 text-slate-900">{getMemberName(b.memberId)}</td><td className="p-3">{getCourseName(b.courseId)}</td><td className="p-3 font-mono">${b.amount}</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs ${b.status === '已付款' ? 'bg-emerald-100 text-emerald-600' : b.status === '待核對' ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-500'}`}>{b.status}</span></td><td className="p-3"><button onClick={() => setBookings(bookings.filter(x => x.id !== b.id))} className="text-slate-300 hover:text-rose-500"><Trash2 className="w-4 h-4" /></button></td></tr>))}</tbody></table></div>
                                    <div className="md:hidden space-y-4">
                                        {bookings.filter(b => b.id.includes(adminSearch) || getMemberName(b.memberId).includes(adminSearch)).map(b => (
                                            <div key={b.id} className="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm relative">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div className="text-[10px] font-black text-slate-400 uppercase tracking-wider font-mono">#{b.id.slice(-6)}</div>
                                                        <div className="font-black text-slate-800 text-lg">{getMemberName(b.memberId)}</div>
                                                    </div>
                                                    <span className={`px-2 py-1 rounded text-xs font-black ${b.status === '已付款' ? 'bg-emerald-100 text-emerald-600' : b.status === '待核對' ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-500'}`}>{b.status}</span>
                                                </div>
                                                <div className="text-xs font-bold text-slate-500 mb-3 pr-8">{getCourseName(b.courseId)}</div>
                                                <div className="flex justify-between items-center pt-3 border-t border-slate-100">
                                                    <div className="flex flex-col">
                                                        <span className="text-[10px] font-bold text-slate-400">日期: {b.date}</span>
                                                        <span className="text-sm font-black text-slate-800 font-mono">${b.amount}</span>
                                                    </div>
                                                    <button onClick={() => setBookings(bookings.filter(x => x.id !== b.id))} className="p-2 bg-white border border-slate-200 rounded-lg text-slate-300 hover:text-rose-500 shadow-sm"><Trash2 className="w-4 h-4" /></button>
                                                </div>
                                            </div>
                                        ))}
                                        {bookings.filter(b => b.id.includes(adminSearch) || getMemberName(b.memberId).includes(adminSearch)).length === 0 && <div className="text-center text-slate-400 font-bold py-8">無訂單資料</div>}
                                    </div>
                                </div>
                            </div>
                        )}
                        {tab === 'courses' && (
                            <div className="bg-white p-8 rounded-2xl border border-slate-200 text-slate-800">
                                <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                    <h3 className="font-black text-xl text-left">課程 / 梯次管理</h3>
                                    <div className="flex gap-2 w-full md:w-auto">
                                        <div className="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 flex-1">
                                            <Search className="w-4 h-4 text-slate-400" />
                                            <input
                                                className="bg-transparent text-sm font-bold outline-none w-full"
                                                placeholder="搜尋課程..."
                                                value={courseSearch}
                                                onChange={e => setCourseSearch(e.target.value)}
                                            />
                                        </div>
                                        <button
                                            onClick={() => setShowHiddenCourses(!showHiddenCourses)}
                                            className={`px-3 py-2 rounded-xl text-xs font-black flex items-center gap-2 transition-all ${showHiddenCourses ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-400'}`}
                                        >
                                            {showHiddenCourses ? <Eye className="w-4 h-4" /> : <EyeOff className="w-4 h-4" />}
                                            {showHiddenCourses ? '顯示隱藏' : '隱藏名單'}
                                        </button>
                                        <button onClick={() => onEditCourse({})} className="px-4 py-2 bg-slate-900 text-white rounded-xl font-black text-sm shadow-lg hover:bg-cyan-600 flex items-center gap-2 whitespace-nowrap"><Plus className="w-4 h-4" /> 新增</button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {courses.filter(c => (showHiddenCourses || !c.isHidden) && c.name.includes(courseSearch)).map(course => (
                                        <div key={course.id} className={`bg-slate-50 rounded-2xl p-4 border border-slate-200 hover:border-cyan-400 transition-all group relative ${course.isHidden ? 'opacity-60 grayscale' : ''}`}>
                                            <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => onEditCourse(course)} className="p-2 bg-white rounded-lg shadow-sm text-slate-400 hover:text-cyan-600"><Pencil className="w-4 h-4" /></button><button onClick={() => setCourses(courses.map(c => c.id === course.id ? { ...c, isHidden: !c.isHidden } : c))} className={`p-2 bg-white rounded-lg shadow-sm hover:text-cyan-600 ${course.isHidden ? 'text-slate-400' : 'text-cyan-600'}`}>{course.isHidden ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}</button></div>
                                            <div className="hidden md:block">{course.image ? <img src={course.image} className="w-full h-32 object-cover rounded-xl mb-3 bg-slate-200" /> : <div className="w-full h-32 rounded-xl mb-3 bg-slate-200 flex items-center justify-center text-slate-400 font-bold">無圖片</div>}</div>
                                            <h4 className="font-black text-slate-800 mb-1 break-words whitespace-pre-line">{course.name}</h4>
                                            <div className="flex gap-2 text-xs font-bold text-slate-500 mb-2"><span className="bg-white px-2 py-1 rounded border border-slate-100">{course.location}</span><span className="bg-white px-2 py-1 rounded border border-slate-100">${course.fullPrice}</span></div>
                                            <div className="text-xs text-slate-400 font-mono">{course.dates.length} 個日期</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {tab === 'payments' && (
                            <div className="bg-white p-8 rounded-2xl border border-slate-200 text-slate-800">
                                <h3 className="font-black text-xl mb-6 text-left">待核對款項 (依末五碼分組)</h3>
                                <div className="space-y-4 text-left">
                                    {(() => {
                                        const pendingBookings = bookings.filter(b => b.status === '待核對');
                                        const grouped = pendingBookings.reduce((acc, b) => { const code = b.last5Digits || 'Unknown'; if (!acc[code]) acc[code] = []; acc[code].push(b); return acc; }, {});
                                        return Object.entries(grouped).map(([code, group]) => (
                                            <div key={code} className="bg-orange-50 border border-orange-100 rounded-xl p-4">
                                                <div className="flex justify-between items-center mb-3"><div className="flex items-center gap-2"><div className="bg-orange-100 text-orange-600 px-2 py-1 rounded text-xs font-black">末五碼: {code}</div><span className="text-xs font-bold text-orange-400">{group.length} 筆款項</span></div><div className="text-lg font-black text-slate-800">${group.reduce((sum, b) => sum + parseInt(b.amount || 0), 0)}</div></div>
                                                <div className="space-y-2 bg-white rounded-lg p-2 border border-orange-100">
                                                    {group.map(b => (
                                                        <div key={b.id} className="flex justify-between items-center text-sm p-2 hover:bg-slate-50 rounded">
                                                            <div><span className="font-black text-slate-700">{getMemberName(b.memberId)}</span><span className="text-xs text-slate-400 font-bold ml-2">({getCourseName(b.courseId)})</span></div>
                                                            <div className="flex items-center gap-3"><span className="font-bold text-slate-600">${b.amount}</span><div className="flex gap-1"><button onClick={() => { if (confirm('確定確認?')) { setIsLoading(true); callApi('apiPayRegistration', b.id).then(res => { if (res && res.registrations) { setBookings(res.registrations.map(r => ({ id: r.id, memberId: r.memberId, courseId: r.courseId, status: r.status, date: r.createdAt ? new Date(r.createdAt).toLocaleDateString('zh-TW') : '', amount: r.amount, last5Digits: r.last5Digits, attendance: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.status }), {}), attendanceRemarks: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.note }), {}), attendDates: r.selectedDates }))); } else { setBookings(bookings.map(x => x.id === b.id ? { ...x, status: '已付款' } : x)); } }).finally(() => setIsLoading(false)); } }} className="px-2 py-1 bg-emerald-100 text-emerald-600 rounded text-xs font-black hover:bg-emerald-200">確認</button><button onClick={() => { if (confirm('確定駁回?')) { setIsLoading(true); callApi('apiRejectRegistration', b.id).then(res => { if (res && res.registrations) { setBookings(res.registrations.map(r => ({ id: r.id, memberId: r.memberId, courseId: r.courseId, status: r.status, date: r.createdAt ? new Date(r.createdAt).toLocaleDateString('zh-TW') : '', amount: r.amount, last5Digits: r.last5Digits, attendance: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.status }), {}), attendanceRemarks: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.note }), {}), attendDates: r.selectedDates }))); } else { setBookings(bookings.map(x => x.id === b.id ? { ...x, status: '待付款', last5Digits: '' } : x)); } }).finally(() => setIsLoading(false)); } }} className="px-2 py-1 bg-rose-100 text-rose-500 rounded text-xs font-black hover:bg-rose-200">駁回</button></div></div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ));
                                    })()}
                                    {bookings.filter(b => b.status === '待核對').length === 0 && <div className="text-center text-slate-400 font-bold py-8">目前無待核對款項</div>}
                                </div>
                            </div>
                        )}
                        {tab === 'attendance' && (
                            <div className="bg-white p-8 rounded-2xl border border-slate-200 text-slate-800">
                                <h3 className="font-black text-xl mb-6 text-left">點名系統 (依梯次)</h3>
                                <div className="relative mb-6">
                                    <input
                                        type="text"
                                        placeholder="搜尋課程或地點..."
                                        className="w-full px-4 py-3 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-400 transition-all"
                                        value={attendanceSearchTerm}
                                        onChange={(e) => setAttendanceSearchTerm(e.target.value)}
                                    />
                                    <Search className="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                                </div>
                                <div className="space-y-6">
                                    {courses.filter(c => (c.name || '').includes(attendanceSearchTerm) || (c.location || '').includes(attendanceSearchTerm)).map(course => (
                                        <div key={course.id} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm text-left">
                                            <div className="flex justify-between items-center mb-4 cursor-pointer hover:bg-slate-50 p-2 rounded-xl transition-colors" onClick={() => { const el = document.getElementById(`attendance-${course.id}`); if (el) el.classList.toggle('hidden'); }}>
                                                <div className="flex items-center gap-4"><img src={course.image} className="w-16 h-16 rounded-xl object-cover bg-slate-100" /><div><h3 className="font-black text-slate-800 text-lg">{course.name}</h3><div className="text-xs font-bold text-slate-400">地點: {course.location}</div></div></div><ChevronRight className="w-5 h-5 text-slate-300" />
                                            </div>
                                            <div id={`attendance-${course.id}`} className="space-y-4 border-t border-slate-100 pt-4 hidden">
                                                <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{(course.dates || []).sort().map(d => (<button key={d} onClick={(e) => { e.stopPropagation(); setSelectedDate(d.split(' ')[0]); }} className={`px-4 py-2 rounded-xl text-sm font-black whitespace-nowrap transition-all ${selectedDate === d.split(' ')[0] ? 'bg-slate-800 text-white shadow-md' : 'bg-slate-50 text-slate-400'}`}>{d.split(' ')[0]}</button>))}</div>
                                                <div className="space-y-2">
                                                    <div className="flex justify-between items-center mb-2"><div className="text-xs font-black text-slate-400 uppercase tracking-wider">{selectedDate} 出席名單 ({bookings.filter(b => b.courseId === course.id && b.attendDates && b.attendDates.some(d => d.includes(selectedDate))).length}人)</div></div>
                                                    {bookings.filter(b => b.courseId === course.id && b.attendDates && b.attendDates.some(d => d.includes(selectedDate))).map(b => (
                                                        <div key={b.id} className="flex flex-col md:flex-row md:items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors gap-3">
                                                            <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-white border-2 border-slate-200 flex items-center justify-center font-black text-slate-500 text-xs">{getMemberName(b.memberId)[0]}</div><div className="font-black text-sm text-slate-800">{getMemberName(b.memberId)}</div></div>
                                                            <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                                                <div className="flex gap-1 bg-white p-1 rounded-lg border border-slate-100 w-full sm:w-auto">
                                                                    {['出席', '請假', '未到'].map(st => (
                                                                        <button key={st} onClick={() => { setBookings(bookings.map(x => x.id === b.id ? { ...x, attendance: { ...(x.attendance || {}), [selectedDate]: st } } : x)); callApi('apiUpdateAttendance', { regId: b.id, date: selectedDate, status: st }); }} className={`flex-1 sm:flex-none px-3 py-1 rounded-md text-xs font-bold transition-all ${b.attendance?.[selectedDate] === st ? st === '出席' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-500' : 'text-slate-300'}`}>{st}</button>
                                                                    ))}
                                                                </div>
                                                                <input className="w-full sm:w-32 bg-white border border-slate-200 rounded-lg px-3 py-1.5 text-xs text-slate-600 outline-none focus:border-cyan-500 transition-colors" placeholder="備註..." value={b.attendanceRemarks?.[selectedDate] || ''} onChange={(e) => setBookings(bookings.map(x => x.id === b.id ? { ...x, attendanceRemarks: { ...(x.attendanceRemarks || {}), [selectedDate]: e.target.value } } : x))} onBlur={(e) => callApi('apiUpdateAttendance', { regId: b.id, date: selectedDate, note: e.target.value })} />
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {addCourseModal && (
                            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 md:p-6 bg-slate-900/60 backdrop-blur-sm animate-in fade-in overflow-hidden">
                                <div className="bg-white rounded-[2.5rem] w-full max-w-3xl shadow-2xl animate-in zoom-in duration-300 relative flex flex-col my-8 max-h-[90vh]">
                                    <div className="p-6 border-b border-slate-100 flex items-center justify-between sticky top-0 bg-white rounded-t-[2.5rem] z-10 shrink-0"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-cyan-100 rounded-xl flex items-center justify-center text-cyan-600"><FileText className="w-6 h-6" /></div><div><div className="text-xs font-black text-slate-400 uppercase tracking-widest">ADMIN</div><h3 className="text-xl font-black text-slate-800">{isEditing ? '編輯梯次' : '建立梯次'}</h3></div></div><button onClick={() => setAddCourseModal(false)} className="p-2 bg-slate-50 text-slate-400 rounded-full hover:bg-slate-100"><X className="w-6 h-6" /></button></div>
                                    <div className="p-8 overflow-y-auto space-y-8 bg-slate-50/50">
                                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                            <h4 className="font-black text-slate-800">基本資訊</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="space-y-1"><label className="text-xs font-bold text-slate-500">梯次名稱</label><input className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold" value={newCourseData.name} onChange={e => setNewCourseData({ ...newCourseData, name: e.target.value })} /></div>
                                                <div className="space-y-1"><label className="text-xs font-bold text-slate-500">地點</label><input className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold" value={newCourseData.location} onChange={e => setNewCourseData({ ...newCourseData, location: e.target.value })} /></div>
                                                <div className="space-y-1"><label className="text-xs font-bold text-slate-500">適合年齡</label><input className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold" value={newCourseData.ageGroup} onChange={e => setNewCourseData({ ...newCourseData, ageGroup: e.target.value })} /></div>
                                                <div className="space-y-1"><label className="text-xs font-bold text-slate-500">活動總時間</label><input className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold" value={newCourseData.duration} onChange={e => setNewCourseData({ ...newCourseData, duration: e.target.value })} /></div>
                                                <div className="space-y-1"><label className="text-xs font-bold text-slate-500">價格</label><input type="number" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold" value={newCourseData.fullPrice} onChange={e => setNewCourseData({ ...newCourseData, fullPrice: e.target.value })} /></div>
                                                <div className="col-span-1 md:col-span-2 bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <label className="text-xs font-black text-yellow-600 flex items-center gap-2"><div className={`w-8 h-5 rounded-full p-1 transition-colors cursor-pointer ${newCourseData.earlyBirdPrice > 0 ? 'bg-yellow-400' : 'bg-slate-200'}`} onClick={() => setNewCourseData({ ...newCourseData, earlyBirdPrice: newCourseData.earlyBirdPrice > 0 ? 0 : (newCourseData.fullPrice - 500) })}><div className={`w-3 h-3 bg-white rounded-full shadow-sm transition-transform ${newCourseData.earlyBirdPrice > 0 ? 'translate-x-3' : 'translate-x-0'}`} /></div> 啟用早鳥優惠</label>
                                                    </div>
                                                    {newCourseData.earlyBirdPrice > 0 && (
                                                        <div className="grid grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-2">
                                                            <div className="space-y-1"><label className="text-xs font-bold text-slate-500">早鳥價格</label><input type="number" className="w-full p-2 bg-white rounded-lg border border-yellow-200 text-sm font-bold text-yellow-600" value={newCourseData.earlyBirdPrice} onChange={e => setNewCourseData({ ...newCourseData, earlyBirdPrice: e.target.value })} /></div>
                                                            <div className="space-y-1"><label className="text-xs font-bold text-slate-500">截止日期</label><input type="date" className="w-full p-2 bg-white rounded-lg border border-yellow-200 text-sm font-bold" value={newCourseData.earlyBirdDeadline} onChange={e => setNewCourseData({ ...newCourseData, earlyBirdDeadline: e.target.value })} /></div>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="space-y-1 md:col-span-1"><label className="text-xs font-bold text-slate-500">封面圖片 URL</label><input className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold" value={newCourseData.image} onChange={e => setNewCourseData({ ...newCourseData, image: e.target.value })} /></div>
                                                <div className="space-y-1 md:col-span-1"><label className="text-xs font-bold text-slate-500">主題色 (無圖片時使用)</label><div className="flex gap-2"><input type="color" className="h-[46px] w-full bg-white rounded-xl border border-slate-200 cursor-pointer p-1" value={newCourseData.themeColor} onChange={e => setNewCourseData({ ...newCourseData, themeColor: e.target.value })} /></div></div>




                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:col-span-2 bg-slate-50 p-4 rounded-xl border border-slate-100">
                                                    <div className="space-y-1 col-span-2 md:col-span-1">
                                                        <label className="text-xs font-bold text-slate-500">名額上限 (空=不限)</label>
                                                        <input type="number" className="w-full p-2 bg-white rounded-lg border border-slate-200 text-sm font-bold" value={newCourseData.capacity || ''} onChange={e => setNewCourseData({ ...newCourseData, capacity: e.target.value })} />
                                                    </div>
                                                    <div className="space-y-1 col-span-2 md:col-span-1">
                                                        <label className="text-xs font-bold text-slate-500">報名截止日</label>
                                                        <input type="date" className="w-full p-2 bg-white rounded-lg border border-slate-200 text-sm font-bold" value={newCourseData.registrationDeadline || ''} onChange={e => setNewCourseData({ ...newCourseData, registrationDeadline: e.target.value })} />
                                                    </div>
                                                    <div className="flex items-center gap-2 col-span-1 md:col-span-1 pt-4">
                                                        <div onClick={() => setNewCourseData({ ...newCourseData, showCapacity: !newCourseData.showCapacity })} className={`w-10 h-6 rounded-full p-1 transition-colors cursor-pointer ${newCourseData.showCapacity !== false ? 'bg-cyan-500' : 'bg-slate-300'}`}>
                                                            <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${newCourseData.showCapacity !== false ? 'translate-x-4' : 'translate-x-0'}`} />
                                                        </div>
                                                        <span className="text-xs font-bold text-slate-600">顯示名額</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 col-span-1 md:col-span-1 pt-4">
                                                        <div onClick={() => setNewCourseData({ ...newCourseData, allowWaitlist: !newCourseData.allowWaitlist })} className={`w-10 h-6 rounded-full p-1 transition-colors cursor-pointer ${newCourseData.allowWaitlist ? 'bg-orange-500' : 'bg-slate-300'}`}>
                                                            <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${newCourseData.allowWaitlist ? 'translate-x-4' : 'translate-x-0'}`} />
                                                        </div>
                                                        <span className="text-xs font-bold text-slate-600">允許候補</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                            <h4 className="font-black text-slate-800">課程詳情</h4>
                                            <textarea className="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold min-h-[12rem] focus:outline-none focus:border-cyan-500 transition-all resize-y placeholder:text-slate-400" placeholder="請輸入課程詳細內容... (支援換行)" value={newCourseData.description || ''} onChange={e => setNewCourseData({ ...newCourseData, description: e.target.value })} />
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                            <div className="flex justify-between items-center"><h4 className="font-black text-slate-800">梯次日期設定</h4></div>
                                            {batches.map((b, idx) => (<div key={idx} className="p-4 bg-slate-50 rounded-xl border border-slate-100 relative"><div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label className="text-xs font-bold text-slate-500">名稱</label><input className="w-full p-2 bg-white rounded-lg border border-slate-200 text-sm font-bold" value={b.name} onChange={e => handleUpdateBatchName(idx, e.target.value)} /></div><div><label className="text-xs font-bold text-slate-500">日期</label><div className="flex gap-2"><input type="date" className="flex-1 p-2 bg-white rounded-lg border border-slate-200 text-sm font-bold" value={b.dateInput} onChange={e => setBatches(batches.map((bat, i) => i === idx ? { ...bat, dateInput: e.target.value } : bat))} /><button onClick={() => handleAddBatchDate(idx, b.dateInput)} className="px-3 bg-slate-200 rounded-lg shadow-sm font-black text-slate-600">+</button><button onClick={() => handleAddConsecutiveDays(idx, b.dateInput, 5)} className="px-3 bg-cyan-100 text-cyan-600 rounded-lg text-xs font-black whitespace-nowrap shadow-sm hover:bg-cyan-200">+5日</button></div></div></div><div className="flex flex-wrap gap-2">{b.dates.map(d => <span key={d} className="bg-cyan-50 text-cyan-700 px-2 py-1 rounded-md text-xs font-bold flex items-center">{d} <button onClick={() => handleRemoveBatchDate(idx, d)} className="ml-1"><X className="w-3 h-3" /></button></span>)}</div></div>))}
                                        </div>
                                    </div>
                                    <div className="p-6 border-t border-slate-100 bg-white rounded-b-[2.5rem] sticky bottom-0 z-10 shrink-0"><button id="save-course-btn" onClick={handleSaveCourse} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-lg shadow-xl hover:bg-cyan-600 transition-all flex items-center justify-center gap-3"><Save className="w-5 h-5" /> {isEditing ? '儲存更新' : '建立梯次'}</button></div>
                                </div>
                            </div>
                        )}
                    </div>
                    {/* Loading Overlay */}
                    {isLoading && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center animate-bounce-in">
                                <div className="w-12 h-12 border-4 border-slate-200 border-t-cyan-500 rounded-full animate-spin mb-4" />
                                <div className="text-lg font-black text-slate-700">處理中...</div>
                                <div className="text-sm font-bold text-slate-400 mt-1">正在同步資料庫</div>
                            </div>
                        </div>
                    )}
                </div>
            )
        };

        // --- User View Component ---
        const UserView = ({ setView, userStatus }) => {
            const [courses, setCourses] = useState(() => JSON.parse(localStorage.getItem('si_courses_v2')) || INITIAL_COURSES);
            const [members, setMembers] = useState(() => JSON.parse(localStorage.getItem('si_members')) || []);
            const [bookings, setBookings] = useState(() => JSON.parse(localStorage.getItem('si_bookings')) || []);
            const [isLoading, setIsLoading] = useState(false);

            // 初始載入：呼叫後端取得最新資料 (包含成員、課程、訂單)
            useEffect(() => {
                const fetchData = async () => {
                    if (!userStatus.userId) return;
                    setIsLoading(true);
                    try {
                        const data = await callApi('getSystemData', { userId: userStatus.userId });
                        if (data) {
                            if (data.courses) setCourses(data.courses);
                            if (data.members) setMembers(data.members);
                            if (data.registrations) {
                                setBookings(data.registrations.map(r => ({
                                    id: r.id,
                                    memberId: r.memberId,
                                    courseId: r.courseId,
                                    status: r.status,
                                    date: r.createdAt ? new Date(r.createdAt).toLocaleDateString('zh-TW') : '',
                                    amount: r.amount,
                                    last5Digits: r.last5Digits,
                                    attendance: r.attendance,
                                    attendDates: r.selectedDates
                                })));
                            }
                        }
                    } catch (e) {
                        console.error('Fetch system data failed:', e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, [userStatus.userId]);

            useEffect(() => localStorage.setItem('si_courses_v2', JSON.stringify(courses)), [courses]);
            useEffect(() => localStorage.setItem('si_members', JSON.stringify(members)), [members]);
            useEffect(() => localStorage.setItem('si_bookings', JSON.stringify(bookings)), [bookings]);



            const [activeTab, setActiveTab] = useState('courses');
            const [searchTerm, setSearchTerm] = useState('');
            const [bookingSearchTerm, setBookingSearchTerm] = useState('');
            const [selectedCourse, setSelectedCourse] = useState(null);
            const [bookingMemberIds, setBookingMemberIds] = useState([]);
            const [wantEquipment, setWantEquipment] = useState(false);
            const [selectedDates, setSelectedDates] = useState([]);
            const [registerModal, setRegisterModal] = useState(false);
            const [formData, setFormData] = useState({ name: '', gender: '', birthday: '', phone: '', address: '', relationship: '本人', identity: '一般', school: '', grade: '', healthStatus: '無', healthDescription: '' });
            const [selectedPlanIndex, setSelectedPlanIndex] = useState(0);
            const [selectedMorning, setSelectedMorning] = useState(null);
            const [selectedAfternoon, setSelectedAfternoon] = useState(null);

            const handleDateToggle = (date) => {
                if (selectedDates.includes(date)) {
                    if (selectedDates.length > 1) setSelectedDates(selectedDates.filter(d => d !== date));
                } else {
                    const newSelection = [...selectedDates, date];
                    const sortedSelection = selectedCourse && selectedCourse.dates
                        ? selectedCourse.dates.filter(d => newSelection.includes(d))
                        : newSelection;
                    setSelectedDates(sortedSelection);
                }
            };

            const renderTimeSlots = (slots) => {
                if (!slots || slots.length === 0) return null;
                return (
                    <div className="flex flex-wrap gap-2 mb-2">
                        {slots.map((slot, i) => (
                            <div key={i} className="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                                <Clock className="w-3 h-3 text-cyan-500" />
                                <span className="text-xs font-black text-slate-800">{slot.time}</span>
                                <span className="text-xs font-bold text-slate-500">{slot.label}</span>
                            </div>
                        ))}
                    </div>
                );
            };

            const formatTimeSlots = (config) => {
                if (!config || !config.timeSlots || config.timeSlots.length === 0) return null;
                return config.timeSlots.map(s => `${s.time.replace(' - ', '~')}${s.label}`).join('，');
            };

            const priceBreakdown = useMemo(() => {
                if (!selectedCourse) return { total: 0, note: '', unitPrice: 0 };

                const plan = (selectedCourse.pricingPlans && selectedCourse.pricingPlans[selectedPlanIndex])
                    ? selectedCourse.pricingPlans[selectedPlanIndex]
                    : { price: selectedCourse.fullPrice || 0, name: '標準方案' };

                let basePrice = parseInt(plan.price || 0);
                let note = plan.name || '';

                const isEarlyBird = selectedCourse.earlyBirdPrice > 0
                    && selectedCourse.earlyBirdDeadline
                    && new Date() <= new Date(selectedCourse.earlyBirdDeadline)
                    && parseInt(plan.price) === parseInt(selectedCourse.fullPrice);

                if (isEarlyBird) {
                    basePrice = parseInt(selectedCourse.earlyBirdPrice);
                    note += ' (早鳥優惠)';
                }

                if (wantEquipment && selectedCourse.equipmentFee?.enabled) {
                    basePrice += parseInt(selectedCourse.equipmentFee.price || 0);
                    note += ' + 器材';
                }

                // 根據選取日期比例計算價格
                let finalUnitPrice = basePrice;
                const totalDatesCount = selectedCourse.dates ? selectedCourse.dates.length : 0;

                // 只有當總天數 > 0 且使用者有勾選日期時，才依比例打折。
                // 若全沒勾 (表示全選預設) 或未選任何天數，保留原價。
                if (totalDatesCount > 0 && selectedDates.length > 0 && selectedDates.length < totalDatesCount) {
                    finalUnitPrice = Math.round(basePrice * (selectedDates.length / totalDatesCount));
                    note += ` (按日計比例: ${selectedDates.length}/${totalDatesCount})`;
                }

                const count = bookingMemberIds.length;
                const total = finalUnitPrice * (count > 0 ? count : 1);

                return { total, note, unitPrice: finalUnitPrice };
            }, [selectedCourse, selectedPlanIndex, wantEquipment, bookingMemberIds, selectedDates]);

            const handlePaymentAndBooking = () => {
                if (!selectedCourse || bookingMemberIds.length === 0) return alert('請至少選擇一位學員');

                const currentCount = selectedCourse.current || 0;
                const capacity = selectedCourse.capacity || 9999;
                const bookingCount = bookingMemberIds.length;
                const isFull = (currentCount + bookingCount) > capacity;
                let bookingStatus = '待付款';

                if (isFull) {
                    if (!selectedCourse.allowWaitlist) return alert(`名額不足。剩餘名額: ${Math.max(0, capacity - currentCount)}`);
                    if (!confirm(`目前名額已滿 (或餘額不足)，將為您排入候補名單 (共 ${bookingCount} 位)，是否繼續？`)) return;
                    bookingStatus = '候補';
                }

                const notesParts = [priceBreakdown.note];
                if (selectedCourse.contentMode !== 'custom') {
                    if (selectedCourse.morningConfig?.mode === 'selectable' && selectedMorning) notesParts.push(`上午: ${selectedMorning}`);
                    if (selectedCourse.afternoonConfig?.mode === 'selectable' && selectedAfternoon) notesParts.push(`下午: ${selectedAfternoon}`);
                }

                const newBookings = bookingMemberIds.map(mid => ({
                    id: `b${Date.now()}_${mid}`,
                    memberId: mid,
                    courseId: selectedCourse.id,
                    status: bookingStatus,
                    date: new Date().toLocaleDateString('zh-TW'),
                    amount: priceBreakdown.unitPrice,
                    notes: notesParts.join(' | '),
                    attendance: {},
                    attendDates: selectedDates.length > 0 ? selectedDates : selectedCourse.dates,
                    last5Digits: ''
                }));

                setBookings([...newBookings, ...bookings]);
                // Only update current count if NOT waitlist? Or always update?
                // Usually waitlist doesn't take up "current" spots in some systems, but here "current" seems to be "enrolled + reserved".
                // If I update current, it stays full.
                // If I don't, people might cut in line?
                // Given the fields "showCapacity" and "capacity", usually "current" tracks confirmed + paid.
                // "waitlist" status bookings shouldn't probably increase "current" count if "current" means "occupied seats".
                // However, for simplicity, let's NOT increase `current` for waitlist, or better:
                // If status is '候補', do not increase `current`.

                let newCurrent = selectedCourse.current;
                if (bookingStatus !== '候補') {
                    newCurrent += bookingMemberIds.length;
                }

                const updatedCourses = courses.map(c => c.id === selectedCourse.id ? { ...c, current: newCurrent } : c);
                setCourses(updatedCourses);
                localStorage.setItem('si_courses_v2', JSON.stringify(updatedCourses));

                // --- ADDED: Actually send the bookings to the backend ---
                setIsLoading(true);
                Promise.all(newBookings.map(b => {
                    const payload = {
                        memberId: b.memberId,
                        courseId: b.courseId,
                        courseTitle: selectedCourse.name,
                        memberName: getMemberName(b.memberId),
                        selectedDates: b.attendDates,
                        totalPrice: b.amount
                    };
                    return callApi('apiAddRegistration', payload);
                })).then(() => {
                    // Refresh data after successful backend write
                    callApi('getSystemData', { userId: userStatus.userId }).then(res => {
                        if (res && res.courses) setCourses(res.courses);
                        if (res && res.members) setMembers(res.members);
                        if (res && res.registrations) {
                            setBookings(res.registrations.map(r => ({
                                id: r.id,
                                memberId: r.memberId,
                                courseId: r.courseId,
                                status: r.status,
                                date: r.createdAt ? new Date(r.createdAt).toLocaleDateString('zh-TW') : '',
                                amount: r.amount,
                                last5Digits: r.last5Digits,
                                attendance: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.status }), {}),
                                attendanceRemarks: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.note }), {}),
                                attendDates: r.selectedDates
                            })));
                        }
                    });
                }).catch(err => {
                    console.error("Booking API Error:", err);
                    alert("部分報名資料寫入失敗，請聯繫管理員");
                }).finally(() => {
                    setIsLoading(false);
                    setBookingMemberIds([]);
                    setWantEquipment(false);
                    setSelectedDates([]);
                    setSelectedCourse(null);
                    setActiveTab('records');
                    alert(bookingStatus === '候補' ? '✅ 已加入候補名單！' : `✅ 報名成功！\n\n已建立 ${bookingMemberIds.length} 筆訂單，已自動跳轉至「報名紀錄」頁面，請記得回報匯款資訊。`);
                });
            };

            const getMemberName = (id) => members.find(m => m.id === id)?.name || '未知會員';
            const openCourseDetail = (course) => {
                setSelectedCourse(course);
                // Initialize selectedDates with all dates available for the course
                setSelectedDates(course.dates || []);
            };
            const submitMember = async (dataToSubmit, closeDialog = false) => {
                if (!dataToSubmit.name || !dataToSubmit.phone || !dataToSubmit.idNumber || !dataToSubmit.gender || !dataToSubmit.birthday || !dataToSubmit.grade) {
                    alert('請填寫所有必填欄位 (*)');
                    return false;
                }

                setIsLoading(true);
                try {
                    const payload = {
                        ...dataToSubmit,
                        userId: userStatus.userId,
                        studentName: dataToSubmit.name,
                        dob: dataToSubmit.birthday,
                        healthCondition: dataToSubmit.healthStatus,
                        parentName: userStatus.name
                    };

                    const response = await callApi('apiAddMember', payload);
                    if (response && response.members) {
                        setMembers(response.members);
                        if (closeDialog) {
                            setRegisterModal(false);
                            setFormData({});
                            alert('註冊成功！');
                        } else {
                            setFormData({});
                            alert('已新增，請繼續新增下一位');
                        }
                        return true;
                    } else {
                        throw new Error(response ? (response.message || '回傳資料格式錯誤') : 'Unknown error');
                    }
                } catch (err) {
                    console.error('Register failed:', err);
                    alert('註冊失敗，請稍後再試。\n' + err.message);
                    return false;
                } finally {
                    setIsLoading(false);
                }
            };

            const handleRegisterSubmit = async (e) => {
                e.preventDefault();
                await submitMember(formData, true);
            };

            const handleReportPayment = (id, code) => {
                setIsLoading(true);
                callApi('apiReportPayment', { id, code }).then(res => {
                    if (res && res.registrations) {
                        setBookings(res.registrations.map(r => ({ id: r.id, memberId: r.memberId, courseId: r.courseId, status: r.status, date: r.createdAt ? new Date(r.createdAt).toLocaleDateString('zh-TW') : '', amount: r.amount, last5Digits: r.last5Digits, attendance: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.status }), {}), attendanceRemarks: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.note }), {}), attendDates: r.selectedDates })));
                    } else {
                        setBookings(bookings.map(b => b.id === id ? { ...b, status: '待核對', last5Digits: code } : b));
                    }
                    alert('已回報');
                }).catch(err => alert('回報失敗: ' + err)).finally(() => setIsLoading(false));
            };

            const handleCancelBooking = (booking) => {
                if (!confirm('確定要取消此報名紀錄？')) return;
                setIsLoading(true);
                callApi('apiCancelRegistration', { id: booking.id }).then(res => {
                    if (res && res.registrations) {
                        setBookings(res.registrations.map(r => ({ id: r.id, memberId: r.memberId, courseId: r.courseId, status: r.status, date: r.createdAt ? new Date(r.createdAt).toLocaleDateString('zh-TW') : '', amount: r.amount, last5Digits: r.last5Digits, attendance: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.status }), {}), attendanceRemarks: Object.keys(r.attendance || {}).reduce((acc, key) => ({ ...acc, [key]: r.attendance[key]?.note }), {}), attendDates: r.selectedDates })));
                    } else {
                        setBookings(prev => prev.filter(b => b.id !== booking.id));
                    }
                    // Fetch courses to update currents
                    callApi('getSystemData', { userId: userStatus.userId }).then(r => {
                        if (r && r.courses) setCourses(r.courses);
                    });
                }).catch(err => alert('取消失敗: ' + err)).finally(() => setIsLoading(false));
            };

            const filteredCourses = courses.filter(c => !c.isHidden && (c.name.includes(searchTerm) || c.location.includes(searchTerm)));

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-24 md:pb-0 relative">
                    {/* Mobile Top Header */}
                    <div className="md:hidden bg-white/90 backdrop-blur-md border-b border-slate-200 p-4 sticky top-0 z-40 flex items-center justify-center relative">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-lg bg-cyan-50 flex items-center justify-center text-cyan-600 shadow-sm"
                                onClick={() => {
                                    const pw = prompt('請輸入管理密碼：');
                                    if (pw === null) return;
                                    if (pw !== '888') { alert('密碼錯誤'); return; }
                                    if (!userStatus.userId) { alert('尚未登入，無法升級'); return; }
                                    callApi('apiPromoteAdmin', { userId: userStatus.userId, password: pw })
                                        .then(res => {
                                            if (res && res.status === 'success') {
                                                alert(res.message || '已升為管理員，請重新整理頁面');
                                                window.location.reload();
                                            } else {
                                                alert('失敗: ' + (res?.message || '未知錯誤'));
                                            }
                                        })
                                        .catch(err => alert('API 錯誤: ' + err));
                                }}
                            ><Palmtree size={20} /></div>
                            <span className="text-lg font-black tracking-tighter text-slate-800">運動島<span className="text-cyan-600">館務系統</span></span>
                        </div>
                    </div>

                    {/* Mobile Bottom Navigation */}
                    {/* Mobile Floating Admin Button - Hand-drawn style */}
                    {/* Mobile Floating Admin Button - Pill Style */}
                    {userStatus.isAdmin && (
                        <button
                            onClick={() => setView('admin')}
                            className="md:hidden fixed bottom-20 right-5 z-50 bg-white text-cyan-700 px-6 py-3 shadow-[0_8px_20px_rgb(0,0,0,0.08)] border border-cyan-200 rounded-full flex items-center justify-center gap-2 font-black text-sm transition-transform active:scale-95"
                        >
                            <ShieldCheck className="w-4 h-4 text-cyan-600" strokeWidth={2.5} />
                            進入後台
                        </button>
                    )}

                    {/* Mobile Bottom Navigation */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-6 py-2 z-50 flex justify-between items-center pb-safe shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
                        {[{ id: 'courses', label: '課程', icon: Calendar }, { id: 'records', label: '紀錄', icon: ClipboardList }, { id: 'members', label: '島民', icon: Users }].map(item => {
                            const isActive = activeTab === item.id;
                            return (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center justify-center w-16 transition-all active:scale-90 gap-1 ${isActive ? 'text-cyan-600' : 'text-slate-400 opacity-60'}`}>
                                    {/* Icon filling logic */}
                                    <item.icon
                                        className={`w-7 h-7 ${(isActive && item.id === 'courses') ? 'fill-current' : ''}`}
                                        strokeWidth={isActive ? 2.5 : 2}
                                    />
                                    <span className={`text-[10px] font-black ${isActive ? 'scale-105' : 'scale-90'}`}>{item.label}</span>
                                </button>
                            );
                        })}
                    </div>

                    <nav className="hidden md:block bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm backdrop-blur-md bg-white/90">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-24 items-center">
                                <div className="flex items-center"><div className="w-14 h-14 rounded-2xl mr-5 overflow-hidden shadow-xl shadow-cyan-200 border-2 border-white bg-cyan-50 flex items-center justify-center text-cyan-600"><Palmtree size={32} /></div><div className="flex flex-col"><span className="text-2xl font-black tracking-tighter text-slate-800 leading-none">運動島<span className="text-cyan-600">館務系統</span></span></div></div>
                                <div className="hidden md:flex space-x-2">
                                    {[{ id: 'courses', label: '課程清單', icon: Calendar }, { id: 'records', label: '報名紀錄', icon: ClipboardList }, { id: 'members', label: '島民名冊', icon: Users }].map(item => (<button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex items-center px-6 py-3 rounded-2xl text-sm font-black transition-all ${activeTab === item.id ? 'bg-slate-900 text-white shadow-xl' : 'text-slate-400 hover:bg-slate-50'}`}><item.icon className="w-4 h-4 mr-3" />{item.label}</button>))}
                                    {userStatus.isAdmin && <button onClick={() => setView('admin')} className="flex items-center px-6 py-3 rounded-2xl text-sm font-black transition-all text-slate-400 hover:bg-slate-50 hover:text-cyan-600"><Settings className="w-4 h-4 mr-3" />後台管理</button>}
                                </div>
                                <div className="hidden md:flex items-center gap-3 ml-4">
                                    {userStatus.pictureUrl && <img src={userStatus.pictureUrl} className="w-10 h-10 rounded-full border-2 border-white shadow-sm" />}
                                    <div className="flex flex-col text-right">
                                        <span className="text-xs font-black text-slate-800">{userStatus.name || '訪客'}</span>
                                        <span className="text-[10px] font-bold text-slate-400 cursor-pointer hover:text-slate-500 transition-colors"
                                            onClick={() => {
                                                const pw = prompt('請輸入管理密碼：');
                                                if (pw === null) return;
                                                if (pw !== '888') { alert('密碼錯誤'); return; }
                                                if (!userStatus.userId) { alert('尚未登入，無法升級'); return; }
                                                callApi('apiPromoteAdmin', { userId: userStatus.userId, password: pw })
                                                    .then(res => {
                                                        if (res && res.status === 'success') {
                                                            alert(res.message || '已升為管理員，請重新整理頁面');
                                                            window.location.reload();
                                                        } else {
                                                            alert('失敗: ' + (res?.message || '未知錯誤'));
                                                        }
                                                    })
                                                    .catch(err => alert('API 錯誤: ' + err));
                                            }}
                                        >{userStatus.isAdmin ? '管理員' : '一般會員'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                        {activeTab === 'courses' && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {filteredCourses.map(course => {
                                    const hasEarlyBird = course.earlyBirdPrice > 0 && new Date(course.earlyBirdDeadline) >= new Date();
                                    const showImage = course.image && course.image.length > 5;
                                    const capacity = course.capacity || 9999;
                                    const remaining = Math.max(0, capacity - course.current);
                                    const progress = Math.min(100, (course.current / capacity) * 100);

                                    return (
                                        <div key={course.id} className="bg-white rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden hover:shadow-xl transition-all group flex flex-col relative">
                                            <div className="hidden md:block relative h-64 w-full shrink-0 bg-slate-100">
                                                {/* Placeholder (Base Layer) */}
                                                <div className="absolute inset-0 w-full h-full flex items-center justify-center p-6 overflow-hidden" style={{ background: course.themeColor || '#10b981' }}>
                                                    <div className="absolute inset-0 bg-gradient-to-b from-black/5 to-black/20" />
                                                    <div className="bg-white/95 backdrop-blur-md px-8 py-6 rounded-3xl shadow-2xl text-center relative z-10 max-w-full mx-4 transform transition-transform group-hover:scale-105 duration-500">
                                                        <h3 className="text-3xl font-black text-slate-800 tracking-tight leading-tight mb-2 break-words whitespace-pre-line">{course.name}</h3>
                                                        <div className="text-sm font-bold text-slate-500 flex items-center justify-center gap-1 bg-slate-100 rounded-lg px-3 py-1 inline-flex mx-auto"><MapPin className="w-3 h-3" /> in {course.location}</div>
                                                    </div>
                                                </div>

                                                {/* Image (Top Layer) */}
                                                {showImage && (
                                                    <img
                                                        src={course.image}
                                                        className="absolute inset-0 w-full h-full object-contain z-20 transition-opacity duration-300 bg-slate-100"
                                                        onError={(e) => e.target.style.opacity = '0'}
                                                        onLoad={(e) => e.target.style.opacity = '1'}
                                                        alt={course.name}
                                                    />
                                                )}
                                                {hasEarlyBird && <div className="absolute top-4 right-4 bg-orange-500 text-white px-4 py-2 rounded-full text-sm font-black shadow-lg animate-bounce flex items-center gap-1"><Zap className="w-4 h-4 fill-current" /> 早鳥優惠中</div>}
                                            </div>

                                            <div className="p-8 flex-grow flex flex-col">
                                                <div className="flex flex-wrap gap-2 mb-4">
                                                    <span className="bg-purple-50 text-purple-600 px-2 py-1 rounded-lg text-[9px] font-black flex items-center gap-1"><MapPin className="w-3 h-3" /> {course.location}</span>
                                                    <span className="bg-teal-50 text-teal-600 px-2 py-1 rounded-lg text-[9px] font-black flex items-center gap-1"><Users className="w-3 h-3" /> {course.ageGroup}</span>
                                                </div>

                                                <h3 className="text-3xl font-black text-slate-800 mb-4 leading-tight break-words whitespace-pre-line">{course.name}</h3>

                                                <div className="space-y-1.5 mb-6">
                                                    <div className="flex items-center gap-2 text-slate-500 text-[10px] font-bold">
                                                        <div className="w-6 h-6 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400"><CalendarDays className="w-3 h-3" /></div>
                                                        {course.dates.length > 0 ? `${course.dates[0].split(' ')[0]} (${['日', '一', '二', '三', '四', '五', '六'][new Date(course.dates[0].split(' ')[0]).getDay()]}) 起` : '日期未定'}
                                                    </div>
                                                    <div className="flex items-center gap-2 text-slate-500 text-[10px] font-bold">
                                                        <div className="w-6 h-6 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400"><Clock className="w-3 h-3" /></div>
                                                        {course.time || course.duration}
                                                    </div>
                                                </div>

                                                {(course.showCapacity !== false && capacity < 9999) && (
                                                    <div className="mb-8">
                                                        <div className="flex justify-between text-xs font-bold mb-2">
                                                            <span className="text-slate-400">名額狀態</span>
                                                            <span className={remaining <= 3 ? "text-orange-500" : "text-emerald-500"}>
                                                                {remaining === 0 ? (course.allowWaitlist ? "已額滿 (可候補)" : "已額滿") : `僅剩 ${remaining} 位`}
                                                            </span>
                                                        </div>
                                                        <div className="h-2.5 bg-slate-100 rounded-full overflow-hidden">
                                                            <div className={`h-full rounded-full transition-all duration-1000 ${remaining === 0 ? 'bg-slate-300' : 'bg-orange-500'}`} style={{ width: `${progress}%` }} />
                                                        </div>
                                                    </div>
                                                )}

                                                <div className="mt-auto pt-6 border-t border-slate-50 flex justify-between items-end">
                                                    <div>
                                                        {hasEarlyBird && <div className="text-xs font-bold text-slate-400 line-through mb-1">原價 ${course.fullPrice.toLocaleString()}</div>}
                                                        <div className="flex items-baseline gap-1">
                                                            <span className="text-3xl font-black text-orange-500">${(hasEarlyBird ? course.earlyBirdPrice : course.fullPrice).toLocaleString()}</span>
                                                            <span className="text-xs font-bold text-slate-400">/ 位</span>
                                                        </div>
                                                        {hasEarlyBird && <div className="text-[10px] font-bold text-orange-400 mt-1">早鳥截止: {course.earlyBirdDeadline?.replace('T', '-').substring(0, 19)}</div>}
                                                    </div>
                                                    <button onClick={() => openCourseDetail(course)} className="px-6 py-4 bg-slate-900 text-white rounded-2xl font-black text-sm hover:bg-slate-800 transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                                                        <Info className="w-4 h-4" /> 預約 / 詳細
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        {activeTab === 'records' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center px-2">
                                    <h3 className="text-xl font-black text-slate-800">我的報名紀錄</h3>
                                </div>
                                <div className="bg-white p-2 rounded-2xl border border-slate-100 shadow-sm mx-2 flex items-center gap-2">
                                    <Search className="w-5 h-5 text-slate-400 ml-2" />
                                    <input
                                        type="text"
                                        placeholder="搜尋課程或學員..."
                                        className="w-full bg-transparent outline-none text-sm font-bold text-slate-700 placeholder:text-slate-300 h-10"
                                        value={bookingSearchTerm}
                                        onChange={(e) => setBookingSearchTerm(e.target.value)}
                                    />
                                    {bookingSearchTerm && <button onClick={() => setBookingSearchTerm('')} className="p-1 hover:bg-slate-100 rounded-full"><X className="w-4 h-4 text-slate-400" /></button>}
                                </div>
                                <div className="grid grid-cols-1 gap-6">
                                    {bookings.filter(b => {
                                        if (!bookingSearchTerm) return true;
                                        const c = courses.find(x => x.id === b.courseId) || {};
                                        const mName = getMemberName(b.memberId);
                                        const term = bookingSearchTerm.toLowerCase();
                                        return (c.name || '').toLowerCase().includes(term) || mName.toLowerCase().includes(term);
                                    }).map(booking => {
                                        const c = courses.find(x => x.id === booking.courseId) || {};
                                        const statusColors = { '待付款': 'bg-rose-500 text-white border-rose-500', '待核對': 'bg-orange-500 text-white border-orange-500', '已付款': 'bg-emerald-500 text-white border-emerald-500', '候補': 'bg-slate-400 text-white border-slate-400' };
                                        return (
                                            <div key={booking.id} className="bg-white rounded-[2.5rem] border-2 border-slate-100 overflow-hidden shadow-sm hover:shadow-xl transition-all relative group">
                                                <div className={`absolute top-0 left-0 px-4 py-2 rounded-br-2xl text-xs font-black z-10 ${statusColors[booking.status] || 'bg-slate-500 text-white'}`}>{booking.status}</div>
                                                <div className="flex flex-col md:flex-row">
                                                    <div className="hidden md:block md:w-1/3 h-48 md:h-auto relative shrink-0 bg-slate-100">
                                                        <div className="absolute inset-0 w-full h-full flex items-center justify-center p-6 relative overflow-hidden" style={{ background: c.themeColor || '#10b981' }}>
                                                            <div className="absolute inset-0 bg-gradient-to-b from-black/5 to-black/20" />
                                                            <div className="bg-white/95 backdrop-blur-md px-6 py-4 rounded-2xl shadow-xl text-center relative z-10 w-full mx-4">
                                                                <h3 className="text-xl font-black text-slate-800 tracking-tight leading-tight mb-1 break-words whitespace-pre-line">{(c.name || '')}</h3>
                                                                <div className="text-[10px] font-bold text-slate-500 flex items-center justify-center gap-1"><MapPin className="w-3 h-3" /> {c.location}</div>
                                                            </div>
                                                        </div>
                                                        {c.image && c.image.length > 5 && (
                                                            <img src={c.image} className="absolute inset-0 w-full h-full object-contain z-20 transition-opacity duration-300 bg-slate-100" onError={(e) => e.target.style.opacity = '0'} onLoad={(e) => e.target.style.opacity = '1'} />
                                                        )}
                                                    </div>
                                                    <div className="flex-1 p-6 pt-14 md:p-8 flex flex-col justify-between">
                                                        <div className="space-y-4 mb-6">
                                                            <div>
                                                                <h3 className="font-black text-xl text-slate-800 mb-2">{(c.name || '')}</h3>
                                                                <div className="flex flex-wrap gap-2">
                                                                    <span className="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-xs font-black flex items-center gap-1"><MapPin className="w-3 h-3" /> {c.location}</span>
                                                                    <span className="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-xs font-black flex items-center gap-1"><Clock className="w-3 h-3" /> {c.time || c.duration}</span>
                                                                </div>
                                                            </div>
                                                            <div className="bg-slate-50 rounded-2xl p-5 border border-slate-100 grid grid-cols-2 gap-4">
                                                                <div className="space-y-1"><div className="text-xs font-black text-slate-400 uppercase">學員姓名</div><div className="font-black text-slate-800 text-lg flex items-center gap-2"><User className="w-4 h-4 text-cyan-500" /> {getMemberName(booking.memberId)}</div></div>
                                                                <div className="space-y-1">
                                                                    <div className="text-xs font-black text-slate-400 uppercase">報名費用</div>
                                                                    <div className="font-black text-slate-800 text-lg flex items-center gap-2">
                                                                        ${booking.amount}
                                                                        <span className={`text-[10px] px-2 py-0.5 rounded-md ${booking.status === '待付款' ? 'bg-rose-100 text-rose-600' : booking.status === '待核對' ? 'bg-orange-100 text-orange-600' : booking.status === '已付款' ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-600'}`}>
                                                                            {booking.status === '待付款' ? '尚未繳費' : booking.status === '待核對' ? '已通知職員' : booking.status === '已付款' ? '繳費成功' : booking.status}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                {booking.last5Digits && <div className="col-span-2 pt-2 border-t border-slate-200 mt-2"><div className="flex justify-between items-center"><span className="text-xs font-bold text-slate-500">匯款帳號末五碼</span><span className="font-mono font-black text-slate-800 bg-white px-2 py-1 rounded border border-slate-200">{booking.last5Digits}</span></div></div>}
                                                            </div>

                                                            {/* Attendance/Leave Section */}
                                                            {c.dates && (
                                                                <div className="space-y-2">
                                                                    <div className="text-xs font-black text-slate-400 uppercase flex items-center gap-1"><CalendarDays className="w-3 h-3" /> 請假申請 (點擊日期)</div>
                                                                    <div className="flex flex-wrap gap-2">
                                                                        {c.dates.map(dateStr => {
                                                                            const date = dateStr.split(' ')[0];
                                                                            const isLeave = booking.attendance?.[date] === '請假';
                                                                            return (
                                                                                <button key={date}
                                                                                    onClick={() => {
                                                                                        if (confirm(isLeave ? '取消請假？' : `確定要請假 (${date})？`)) {
                                                                                            setBookings(bookings.map(b => b.id === booking.id ? { ...b, attendance: { ...(b.attendance || {}), [date]: isLeave ? '出席' : '請假' } } : b));
                                                                                        }
                                                                                    }}
                                                                                    className={`px-3 py-1.5 rounded-xl text-xs font-black border-2 transition-all ${isLeave ? 'bg-orange-50 border-orange-200 text-orange-600' : 'bg-white border-slate-100 text-slate-400 hover:border-cyan-200 hover:text-cyan-600'}`}
                                                                                >
                                                                                    {date.slice(5)} {isLeave && '假'}
                                                                                </button>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>

                                                        <div className="pt-4 border-t border-slate-50 w-full">
                                                            {booking.status === '待付款' ? (
                                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                                    <div className="relative md:col-span-2 flex gap-2">
                                                                        <input id={`pay-${booking.id}`} placeholder="繳費後，輸入銀行帳號後5碼" className="flex-1 bg-slate-50 border-2 border-slate-100 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:border-cyan-500 transition-colors" />
                                                                        <button onClick={() => { const val = document.getElementById(`pay-${booking.id}`).value; if (val) handleReportPayment(booking.id, val); else alert('請輸入末五碼'); }} className="px-6 bg-slate-900 text-white rounded-xl font-black text-sm hover:bg-cyan-600 shadow-lg transition-all flex items-center justify-center gap-2 whitespace-nowrap"><Check className="w-4 h-4" /> 回報</button>
                                                                    </div>
                                                                    <button onClick={() => handleCancelBooking(booking)} className="md:col-span-2 py-3 text-slate-400 bg-slate-100/50 hover:bg-rose-50 hover:text-rose-500 rounded-xl font-black text-xs transition-all flex items-center justify-center gap-1 w-full dashed border-2 border-slate-200 hover:border-rose-200"><Trash2 className="w-3 h-3" /> 取消報名</button>
                                                                </div>
                                                            ) : (
                                                                <div className="flex gap-3 justify-end">
                                                                    <button onClick={() => handleCancelBooking(booking)} className="px-4 py-3 text-slate-300 hover:text-rose-500 rounded-xl font-black text-xs transition-all flex items-center justify-center gap-1"><Trash2 className="w-3 h-3" /> 取消報名</button>
                                                                    <button onClick={() => openCourseDetail(c)} className="px-5 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-xs hover:bg-slate-200 transition-all flex items-center justify-center gap-2"><Info className="w-3 h-3" /> 課程詳細</button>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                    {bookings.length === 0 && <div className="text-center py-20 text-slate-400 font-bold bg-white rounded-[2.5rem] border border-slate-100">尚無報名紀錄</div>}
                                </div>
                            </div>
                        )}
                        {activeTab === 'members' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center"><h3 className="text-xl font-black text-slate-800 ml-2">島民名冊</h3><button onClick={() => { setFormData({}); setRegisterModal(true); }} className="px-4 py-2 bg-slate-900 text-white rounded-xl font-black text-sm shadow-lg">+ 新增島民</button></div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {members.length === 0 ? (
                                        <div className="col-span-1 md:col-span-2 text-center py-20 text-slate-400 font-bold bg-white rounded-[2.5rem] border border-slate-100">尚未註冊島民</div>
                                    ) : (
                                        members.map(m => (<div key={m.id} className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm flex items-center justify-between"><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center font-black text-slate-400 text-lg">{(m.name && m.name[0]) || '?'}</div><div><div className="font-black text-slate-800">{m.name || '未命名'}</div><div className="text-xs font-bold text-slate-500">{m.identity || m.relationship || '一般'} | {m.birthday || '未提供生日'}</div></div></div><button onClick={() => { setFormData(m); setRegisterModal(true); }}><Pencil className="w-4 h-4 text-slate-400" /></button></div>))
                                    )}
                                </div>
                            </div>
                        )}
                    </main>

                    {registerModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-2xl relative shadow-2xl max-h-[90vh] flex flex-col">
                                <div className="p-8 border-b border-slate-100 flex items-center justify-between sticky top-0 bg-white rounded-t-[2.5rem] z-10"><h3 className="text-2xl font-black text-slate-800">{formData.id ? '編輯島民資料' : '註冊新島民'}</h3><button onClick={() => { setRegisterModal(false); setFormData({}); }} className="p-2 bg-slate-50 text-slate-400 rounded-full hover:bg-slate-100"><X className="w-5 h-5" /></button></div>
                                <form className="p-8 space-y-6 overflow-y-auto">
                                    <div className="space-y-4">
                                        <div className="space-y-2"><label className="text-xs font-black text-slate-400 ml-1">姓名 <span className="text-rose-500">*</span></label><input type="text" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold placeholder:text-slate-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all" value={formData.name || ''} onChange={e => setFormData({ ...formData, name: e.target.value })} /></div>
                                        <div className="space-y-2"><label className="text-xs font-black text-slate-400 ml-1">手機 <span className="text-rose-500">*</span></label><input type="tel" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold placeholder:text-slate-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all" value={formData.phone || ''} onChange={e => setFormData({ ...formData, phone: e.target.value })} /></div>

                                        <div className="space-y-2">
                                            <label className="text-xs font-black text-slate-400 ml-1 uppercase">家庭關係 (FAMILY ROLE)</label>
                                            <div className="flex flex-wrap gap-2">
                                                {['本人', '配偶', '子女', '父母', '其他'].map(role => (
                                                    <button key={role} type="button" onClick={() => setFormData({ ...formData, relationship: role })} className={`px-5 py-2 rounded-xl text-sm font-bold transition-all ${formData.relationship === role ? 'bg-indigo-500 text-white shadow-lg shadow-indigo-200' : 'bg-slate-50 text-slate-400 border border-slate-100'}`}>
                                                        {role}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="space-y-2"><label className="text-xs font-black text-slate-400 ml-1">身分證字號 <span className="text-rose-500">*</span> (保險用)</label><input type="text" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold placeholder:text-slate-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all uppercase" value={formData.idNumber || ''} onChange={e => setFormData({ ...formData, idNumber: e.target.value.toUpperCase() })} /></div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-2"><label className="text-xs font-black text-slate-400 ml-1">性別 <span className="text-rose-500">*</span></label><select required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none text-slate-600" value={formData.gender || ''} onChange={e => setFormData({ ...formData, gender: e.target.value })}><option value="">請選擇</option><option value="男">男</option><option value="女">女</option></select></div>
                                            <div className="space-y-2"><label className="text-xs font-black text-slate-400 ml-1">出生年月日 <span className="text-rose-500">*</span></label><input type="date" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all text-slate-600" value={formData.birthday || ''} onChange={e => setFormData({ ...formData, birthday: e.target.value })} /></div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-2"><label className="text-xs font-black text-slate-400 ml-1">學校/補習班</label><input type="text" className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold placeholder:text-slate-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all" value={formData.school || ''} onChange={e => setFormData({ ...formData, school: e.target.value })} /></div>
                                            <div className="space-y-2"><label className="text-xs font-black text-slate-400 ml-1">年級 <span className="text-rose-500">*</span></label><input type="text" required className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold placeholder:text-slate-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition-all" value={formData.grade || ''} onChange={e => setFormData({ ...formData, grade: e.target.value })} /></div>
                                        </div>

                                        <div className="space-y-2">
                                            <label className="text-xs font-black text-slate-400 ml-1">飲食狀況</label>
                                            <div className="flex gap-4">
                                                <label className="flex items-center gap-2 cursor-pointer bg-slate-50 px-4 py-3 rounded-xl border border-slate-100 flex-1">
                                                    <input type="radio" name="diet" value="葷" checked={formData.diet === '葷' || !formData.diet} onChange={() => setFormData({ ...formData, diet: '葷' })} className="w-4 h-4 text-cyan-600" />
                                                    <span className="text-sm font-bold text-slate-600">葷</span>
                                                </label>
                                                <label className="flex items-center gap-2 cursor-pointer bg-slate-50 px-4 py-3 rounded-xl border border-slate-100 flex-1">
                                                    <input type="radio" name="diet" value="素" checked={formData.diet === '素'} onChange={() => setFormData({ ...formData, diet: '素' })} className="w-4 h-4 text-cyan-600" />
                                                    <span className="text-sm font-bold text-slate-600">素</span>
                                                </label>
                                            </div>
                                        </div>

                                        <div className="p-4 border border-slate-100 rounded-2xl bg-slate-50/50 space-y-3">
                                            <div className="text-xs font-black text-slate-400 flex items-center gap-2"><HeartPulse className="w-4 h-4" /> 身體特殊狀況</div>
                                            <div className="grid grid-cols-2 gap-3">
                                                <button type="button" onClick={() => setFormData({ ...formData, healthStatus: '無', healthDescription: '' })} className={`py-3 rounded-xl text-sm font-black transition-all ${(!formData.healthStatus || formData.healthStatus === '無') ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-200' : 'bg-white text-slate-400 border border-slate-200'}`}>無</button>
                                                <button type="button" onClick={() => setFormData({ ...formData, healthStatus: '有' })} className={`py-3 rounded-xl text-sm font-black transition-all ${formData.healthStatus === '有' ? 'bg-rose-500 text-white shadow-lg shadow-rose-200' : 'bg-white text-slate-400 border border-slate-200'}`}>有</button>
                                            </div>
                                            {formData.healthStatus === '有' && (
                                                <textarea className="w-full px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-bold placeholder:text-slate-300 focus:outline-none focus:ring-2 focus:ring-rose-500 transition-all animate-in fade-in slide-in-from-top-2" placeholder="請描述特殊狀況..." value={formData.healthDescription || ''} onChange={e => setFormData({ ...formData, healthDescription: e.target.value })} rows="3"></textarea>
                                            )}
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 pt-4">
                                        <button type="button" onClick={() => submitMember(formData, false)} className="py-4 bg-emerald-500 text-white rounded-2xl font-black text-sm shadow-xl shadow-emerald-200 hover:bg-emerald-600 transition-all flex items-center justify-center gap-2"><UserPlus className="w-5 h-5" /> 儲存並新增成員</button>
                                        <button type="button" onClick={handleRegisterSubmit} className="py-4 bg-slate-900 text-white rounded-2xl font-black text-sm shadow-xl shadow-slate-200 hover:bg-slate-800 transition-all">完成註冊</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {
                        selectedCourse && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center p-0 md:p-6 bg-slate-900/60 backdrop-blur-sm animate-in fade-in overflow-hidden">
                                <div className="bg-white md:rounded-[3rem] w-full max-w-2xl shadow-2xl animate-in zoom-in duration-300 relative flex flex-col h-[100dvh] md:h-auto md:my-8 md:max-h-[90vh]">
                                    <div className="p-6 border-b border-slate-100 flex items-center justify-between sticky top-0 bg-white md:rounded-t-[3rem] z-10 shrink-0">
                                        <div><div className="text-xs font-black text-cyan-600 uppercase tracking-widest mb-1">COURSE BOOKING</div><h3 className="text-2xl font-black text-slate-800 break-words whitespace-pre-line">{selectedCourse.name}</h3></div>
                                        <button onClick={() => setSelectedCourse(null)} className="p-2 bg-slate-50 text-slate-400 rounded-full hover:bg-slate-100"><X className="w-6 h-6" /></button>
                                    </div>
                                    <div className="p-6 overflow-y-auto space-y-8 flex-1">
                                        <div className="bg-white px-2 mb-4">
                                            <div className="flex justify-between items-center mb-4">
                                                <h4 className="text-sm font-black text-slate-800">報名學員 (可多選)</h4>
                                                <button onClick={() => setRegisterModal(true)} className="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs font-black hover:bg-cyan-50 hover:text-cyan-600 flex items-center gap-1 transition-all"><UserPlus className="w-3 h-3" /> 新增</button>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                {members.map(m => {
                                                    const isSelected = bookingMemberIds.includes(m.id);
                                                    const isRegistered = bookings.some(b => b.memberId === m.id && b.courseId === selectedCourse.id && !['已取消', '已退費'].includes(b.status));

                                                    const hasConflict = !isRegistered && bookings.some(b => {
                                                        if (b.memberId !== m.id || ['已取消', '已退費'].includes(b.status) || b.courseId === selectedCourse.id) return false;
                                                        const otherCourse = courses.find(c => c.id === b.courseId);
                                                        if (!otherCourse) return false;
                                                        const overlap = otherCourse.dates.some(d => selectedCourse.dates.includes(d));
                                                        return overlap;
                                                    });

                                                    return (
                                                        <button key={m.id} onClick={() => {
                                                            if (isRegistered) return alert('此孩子已報名該梯次');
                                                            if (hasConflict) return alert('此時段已有課程，請改選其他梯次');
                                                            setBookingMemberIds(prev => isSelected ? prev.filter(id => id !== m.id) : [...prev, m.id]);
                                                        }} className={`p-3 rounded-xl border flex items-center justify-between text-xs font-bold transition-all ${(isRegistered || hasConflict) ? 'bg-slate-50 text-slate-400 border-slate-100 opacity-60' :
                                                            isSelected ? 'bg-cyan-600 text-white border-cyan-600' :
                                                                'bg-white text-slate-600 border-slate-200 hover:border-cyan-300'
                                                            }`}>
                                                            <span>{m.name}</span>
                                                            <span className="opacity-70">
                                                                {(isRegistered || hasConflict) ? (isRegistered ? '已報名' : '衝堂') : m.identity}
                                                            </span>
                                                        </button>
                                                    )
                                                })}
                                            </div>
                                        </div>

                                        <div className="flex flex-col gap-3 p-5 bg-slate-50 rounded-2xl border border-slate-100 mb-6 mx-2">
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-slate-400 shadow-sm shrink-0"><MapPin className="w-4 h-4" /></div>
                                                <div className="font-black text-slate-800 text-base flex-1">地點: {selectedCourse.location}</div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-slate-400 shadow-sm shrink-0"><School className="w-4 h-4" /></div>
                                                <div className="font-black text-slate-800 text-base flex-1">適合年齡: {selectedCourse.ageGroup}</div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-slate-400 shadow-sm shrink-0"><Clock className="w-4 h-4" /></div>
                                                <div className="font-black text-slate-800 text-base flex-1">活動時間: {selectedCourse.time}</div>
                                            </div>

                                            <div className="grid grid-cols-2 gap-3 mt-2 border-t border-slate-200 pt-3">
                                                <div className="space-y-1">
                                                    <div className="text-xs font-bold text-slate-400">價格</div>
                                                    <div className="text-sm font-black text-slate-800">${selectedCourse.fullPrice || 0}</div>
                                                </div>
                                                <div className="space-y-1">
                                                    <div className="text-xs font-bold text-slate-400">名額上限</div>
                                                    <div className="text-sm font-black text-slate-800">{selectedCourse.capacity || '無限制'}</div>
                                                </div>
                                                <div className="space-y-1">
                                                    <div className="text-xs font-bold text-slate-400">早鳥價格 / 截止</div>
                                                    <div className="text-sm font-black text-slate-800">
                                                        {selectedCourse.earlyBirdPrice ? `$${selectedCourse.earlyBirdPrice}` : '-'}
                                                        {selectedCourse.earlyBirdDeadline ? ` / ${selectedCourse.earlyBirdDeadline?.replace('T', '-').substring(0, 19)}` : ''}
                                                    </div>
                                                </div>
                                                <div className="space-y-1">
                                                    <div className="text-xs font-bold text-slate-400">報名截止日</div>
                                                    <div className="text-sm font-black text-slate-800">{selectedCourse.registrationDeadline || '-'}</div>
                                                </div>
                                            </div>

                                            {/* Date Selection Buttons */}
                                            {selectedCourse.dates && selectedCourse.dates.length > 0 && (
                                                <div className="mt-3 pt-3 border-t border-slate-200">
                                                    <div className="text-xs font-bold text-slate-500 mb-2 flex justify-between items-center">
                                                        <span>日期 (點擊取消/選擇)</span>
                                                        <span className="text-[10px] text-cyan-600 font-black px-2 py-0.5 bg-cyan-50 rounded">依選擇天數計價</span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2">
                                                        {selectedCourse.dates.map(dateStr => {
                                                            // If selectedDates is empty, it means ALL dates are selected implicitly based on previous logic, but let's make it explicit here for UI
                                                            // We should initialize selectedDates when opening the modal, or treat empty as "all selected". 
                                                            // Based on handleDateToggle, it toggles. We assume all selected by default.
                                                            const isSelected = selectedDates.length === 0 || selectedDates.includes(dateStr);
                                                            return (
                                                                <button
                                                                    key={dateStr}
                                                                    onClick={() => handleDateToggle(dateStr)}
                                                                    className={`px-3 py-1.5 rounded-xl border text-xs font-black transition-all active:scale-95 ${isSelected
                                                                        ? 'bg-cyan-50 border-cyan-200 text-cyan-700 shadow-sm'
                                                                        : 'bg-white border-slate-200 text-slate-400 opacity-60'
                                                                        }`}
                                                                >
                                                                    {dateStr}
                                                                </button>
                                                            )
                                                        })}
                                                    </div>

                                                    {/* Display dynamic price calculation */}
                                                    <div className="mt-3 bg-cyan-600 p-3 rounded-xl shadow-md text-white flex justify-between items-center">
                                                        <div>
                                                            <div className="text-[10px] font-bold opacity-80 uppercase tracking-wider">合計報名費</div>
                                                            <div className="text-xs font-bold mt-0.5 opacity-90">{priceBreakdown.note}</div>
                                                        </div>
                                                        <div className="text-xl font-black">${priceBreakdown.total}</div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        {selectedCourse.description && (
                                            <div className="space-y-4 px-2 mb-6">
                                                <h4 className="text-xl font-black text-slate-800">課程詳情</h4>
                                                <div className="text-slate-800 font-bold leading-relaxed whitespace-pre-line text-base ml-1">
                                                    {selectedCourse.description}
                                                </div>
                                            </div>
                                        )}



                                        {/* Content (Custom vs Structured) */}




                                        {/* Equipment Fee Option */}





                                        {/* Additional Info Sections */}
                                        {(selectedCourse.equipment && selectedCourse.equipment.length > 0) && (
                                            <div className="space-y-2">
                                                <h4 className="text-sm font-black text-slate-800 flex items-center gap-2"><Backpack className="w-4 h-4 text-slate-400" /> 攜帶物品與裝備</h4>
                                                <ul className="bg-slate-50 p-4 rounded-xl list-disc list-inside text-xs font-bold text-slate-600 space-y-1">
                                                    {selectedCourse.equipment.map((item, i) => <li key={i}>{item}</li>)}
                                                </ul>
                                            </div>
                                        )}
                                        {(selectedCourse.importantNotices && selectedCourse.importantNotices.length > 0) && (
                                            <div className="space-y-2">
                                                <h4 className="text-sm font-black text-slate-800 flex items-center gap-2"><AlertCircle className="w-4 h-4 text-slate-400" /> 重要事項與繳費須知</h4>
                                                <ul className="bg-orange-50 p-4 rounded-xl list-disc list-inside text-xs font-bold text-orange-700 space-y-1">
                                                    {selectedCourse.importantNotices.map((item, i) => <li key={i}>{item}</li>)}
                                                </ul>
                                            </div>
                                        )}
                                    </div>
                                    <div className="p-6 pb-safe border-t border-slate-100 bg-slate-50 md:rounded-b-[3rem] shrink-0 z-10 relative">

                                        {(() => {
                                            const currentCount = selectedCourse.current || 0;
                                            const capacity = selectedCourse.capacity || 9999;
                                            const bookingCount = bookingMemberIds.length;
                                            const isFull = (currentCount + bookingCount) > capacity;
                                            const isWaitlist = selectedCourse.allowWaitlist && isFull;
                                            const isSoldOut = isFull && !selectedCourse.allowWaitlist;

                                            return (
                                                <button
                                                    onClick={() => {
                                                        if (selectedCourse.googleFormUrl) {
                                                            window.open(selectedCourse.googleFormUrl, '_blank');
                                                        } else {
                                                            handlePaymentAndBooking();
                                                        }
                                                    }}
                                                    disabled={isSoldOut && !selectedCourse.googleFormUrl}
                                                    className={`w-full py-4 rounded-2xl font-black text-lg shadow-xl transition-all flex items-center justify-center gap-3 ${selectedCourse.googleFormUrl ? 'bg-slate-900 text-white hover:bg-cyan-600' :
                                                        isSoldOut ? 'bg-slate-200 text-slate-400 cursor-not-allowed shadow-none' :
                                                            isWaitlist ? 'bg-orange-500 text-white hover:bg-orange-600' :
                                                                'bg-slate-900 text-white hover:bg-cyan-600'
                                                        }`}
                                                >
                                                    {selectedCourse.googleFormUrl ? (
                                                        <><ArrowRight className="w-5 h-5" /> 前往報名表單</>
                                                    ) : isSoldOut ? (
                                                        <><X className="w-5 h-5" /> 已額滿</>
                                                    ) : isWaitlist ? (
                                                        <><Clock className="w-5 h-5" /> 加入候補</>
                                                    ) : (
                                                        <><ArrowRight className="w-5 h-5" /> 報名並查看方案</>
                                                    )}
                                                </button>
                                            );
                                        })()}
                                    </div>
                                </div>
                            </div>
                        )
                    }


                </div>
            )
        };

        // --- Main App Component ---
        const MainApp = () => {
            const [view, setView] = useState('user');
            const [userStatus, setUserStatus] = useState({ userId: null, isAdmin: false, name: '', pictureUrl: '' });
            const [isLiffInitialized, setIsLiffInitialized] = useState(false);
            const [liffError, setLiffError] = useState(null);
            const [debugMsg, setDebugMsg] = useState('準備載入 LIFF...');

            useEffect(() => {
                const initLIFF = async () => {
                    try {
                        setDebugMsg('檢查 LIFF SDK...');

                        // 1. 等待 SDK 載入 (最多等 5 秒)
                        let retries = 0;
                        while (typeof window.liff === 'undefined' && retries < 20) {
                            await new Promise(r => setTimeout(r, 250));
                            retries++;
                        }

                        // 若 window.liff 仍不存在，嘗試動態載入
                        if (typeof window.liff === 'undefined') {
                            setDebugMsg('LIFF SDK 未偵測到，嘗試動態載入...');
                            await new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
                                script.onload = resolve;
                                script.onerror = reject;
                                document.head.appendChild(script);
                            });
                        }

                        if (typeof window.liff === 'undefined') {
                            throw new Error("LIFF SDK 載入失敗 (window.liff undefined)");
                        }

                        // 稍微等待一下確保 Native Bridge 準備好 (針對 LINE In-App Browser)
                        await new Promise(r => setTimeout(r, 500));

                        setDebugMsg('正在執行 liff.init (Delay 500ms)...');


                        // 設定 10 秒 timeout，避免永久卡住
                        const initPromise = window.liff.init({ liffId: "2008704329-qROthcbB" });
                        const timeoutPromise = new Promise((_, reject) =>
                            setTimeout(() => reject(new Error("LIFF Init Timeout (10s)")), 10000)
                        );

                        await Promise.race([initPromise, timeoutPromise]);


                        setDebugMsg('liff.init 完成，檢查登入狀態...');

                        // 判斷是否由 LINE App 內開啟，或已登入
                        if (window.liff.isLoggedIn()) {
                            setDebugMsg('已登入 LIFF，取得個人檔案...');
                            const profile = await window.liff.getProfile();
                            setDebugMsg(`取得 Profile: ${profile.userId}`);
                            const userId = profile.userId;

                            // 先設定 UserStatus，再開起畫面，避免閃爍
                            const apiVerify = async () => {
                                setDebugMsg('呼叫 apiLogin 驗證中...');
                                try {
                                    const response = await callApi('apiLogin', userId);
                                    setDebugMsg('apiLogin 回傳成功');
                                    if (response) {
                                        setUserStatus({
                                            userId: userId,
                                            isAdmin: response.isAdmin,
                                            name: profile.displayName,
                                            pictureUrl: profile.pictureUrl
                                        });
                                    }
                                } catch (err) {
                                    console.error("Login Verify Failed:", err);
                                    setDebugMsg(`apiLogin 失敗: ${err.message}`);
                                } finally {
                                    setIsLiffInitialized(true); // 資料準備好才顯示畫面
                                }
                            };
                            apiVerify();
                        } else {
                            // 未登入，直接顯示 Login 畫面
                            setIsLiffInitialized(true);
                        }

                    } catch (err) {
                        console.error('LIFF Init failed', err);
                        setLiffError(err.toString());
                        setDebugMsg(`LIFF Error: ${err.toString()}`);
                        setIsLiffInitialized(true);
                    }
                };
                initLIFF();
            }, []);

            if (!isLiffInitialized) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-400 font-bold p-10 text-center">
                        <div className="mb-4">載入中...</div>
                        <div className="text-xs font-mono bg-slate-200 p-2 rounded text-slate-600 break-all">{debugMsg}</div>
                    </div>
                );
            }

            if (liffError) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-rose-500 font-bold p-4 text-center">
                        <div className="mb-4">初始化失敗: {liffError}</div>
                        <div className="mb-4 text-xs text-slate-500">
                            可能的解法：<br />
                            1. 確認 LIFF ID 正確<br />
                            2. 確認 LINE Developer Console 的 Endpoint URL 設定正確<br />
                        </div>
                        <button onClick={() => window.location.reload()} className="bg-slate-800 text-white px-6 py-2 rounded-lg shadow-lg mb-4">
                            重新整理
                        </button>
                        <br />
                        <button
                            onClick={() => {
                                setDebugMsg('進入開發者繞過模式');
                                setUserStatus({ userId: 'DEV_GUEST', isAdmin: true, name: '開發測試員', pictureUrl: '' });
                                setIsLiffInitialized(true);
                                setLiffError(null);
                            }}
                            className="text-slate-400 underline text-sm"
                        >
                            跳過登入 (Dev Mode)
                        </button>
                    </div>
                );
            }

            // 若未登入，顯示登入按鈕 (避免鬼打牆)
            if (!userStatus.userId) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 p-6 space-y-6">
                        <div className="w-24 h-24 rounded-3xl bg-cyan-50 flex items-center justify-center text-cyan-600 shadow-xl mb-4">
                            <Palmtree size={48} />
                        </div>
                        <h2 className="text-2xl font-black text-slate-800">運動島館務系統</h2>
                        <p className="text-slate-500 font-bold text-center max-w-xs">請登入 LINE 帳號以存取系統功能</p>
                        <button
                            onClick={() => window.liff.login()}
                            className="bg-[#06C755] hover:bg-[#05b34c] text-white px-8 py-4 rounded-2xl font-black text-lg shadow-lg shadow-emerald-100 transition-all active:scale-95 flex items-center gap-2"
                        >
                            <span>使用 LINE 登入</span>
                        </button>
                    </div>
                );
            }

            return view === 'user' ? <UserView setView={setView} userStatus={userStatus} /> : <AdminView setView={setView} userStatus={userStatus} />;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>

</html>