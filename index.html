<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‹å‹•å³¶èª²ç¨‹å ±åç³»çµ±</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide-react@0.263.1/dist/lucide-react.umd.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; user-select: none; background-color: #f3f4f6; }
        #root { min-height: 100vh; background-color: #f9fafb; position: relative; }
        
        /* è®€å–ä¸­é®ç½©å‹•ç•« */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        
        // â˜…â˜…â˜… è¨­å®šå€ï¼šè«‹å°‡ä¸‹æ–¹çš„ç¶²å€æ›æˆæ‚¨ GAS éƒ¨ç½²å¾Œçš„ /exec ç¶²å€ â˜…â˜…â˜…
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzPkZY0cG0Z4vNqs2c32QbbP9tiFbwJzKeo8Ru5lz6W-lteW4ety_7BZTHpbiskWM7Ogw/exec"; 
        
        // â˜…â˜…â˜… è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ LIFF ID â˜…â˜…â˜…
        const MY_LIFF_ID = "2008704329-qROthcbB";

        // --- 0. åœ–ç¤ºè™•ç† ---
        const LucideIcons = window.lucideReact || window.LucideReact || {};
        const FallbackIcons = {
            Search: () => <span>ğŸ”</span>, Plus: () => <span>â•</span>, Edit: () => <span>âœï¸</span>, 
            EyeOff: () => <span>ğŸ‘ï¸â€ğŸ—¨ï¸</span>, Trash2: () => <span>ğŸ—‘ï¸</span>, Home: () => <span>ğŸ </span>, 
            ClipboardList: () => <span>ğŸ“‹</span>, Users: () => <span>ğŸ‘¥</span>, Calendar: () => <span>ğŸ“…</span>, 
            MapPin: () => <span>ğŸ“</span>, Clock: () => <span>â°</span>, UserCircle: () => <span>ğŸ‘¤</span>, 
            ShieldCheck: () => <span>ğŸ›¡ï¸</span>, CheckCircle: () => <span>âœ…</span>, X: () => <span>âŒ</span>, 
            CheckSquare: () => <span>â˜‘ï¸</span>, ListPlus: () => <span>ğŸ“</span>, Tag: () => <span>ğŸ·ï¸</span>, 
            UserPlus: () => <span>â•</span>, Baby: () => <span>ğŸ‘¶</span>, School: () => <span>ğŸ«</span>, 
            History: () => <span>ğŸ“œ</span>, ArrowLeft: () => <span>â¬…ï¸</span>, AlertTriangle: () => <span>âš ï¸</span>, 
            CreditCard: () => <span>ğŸ’³</span>, Info: () => <span>â„¹ï¸</span>, RefreshCw: () => <span>ğŸ”„</span>
        };
        const Icons = {};
        Object.keys(FallbackIcons).forEach(name => {
            Icons[name] = LucideIcons[name] ? LucideIcons[name] : FallbackIcons[name];
        });
        const { 
            Search, Plus, Edit, EyeOff, Trash2, Home, ClipboardList, Users, 
            Calendar, MapPin, Clock, UserCircle, ShieldCheck, CheckCircle, 
            X, CheckSquare, ListPlus, Tag, UserPlus, Baby, School, History, 
            ArrowLeft, AlertTriangle, CreditCard, Info, RefreshCw
        } = Icons;

        const { useState, useEffect } = React;

        // --- æ–°å¢ï¼šæ ¸å¿ƒ API å‘¼å«å‡½å¼ (å–ä»£ google.script.run) ---
        const callApi = async (actionName, payload = null) => {
            try {
                // ä½¿ç”¨ fetch ç™¼é€ POST è«‹æ±‚
                const response = await fetch(GAS_API_URL, {
                    method: "POST",
                    mode: "cors", // å…è¨±è·¨åŸŸ
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8", // é¿é–‹ GAS çš„ OPTIONS é æª¢
                    },
                    body: JSON.stringify({ action: actionName, payload: payload })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    return result.data;
                } else {
                    throw new Error(result.message || "å¾Œç«¯ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤");
                }
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        };

        // --- è³‡æ–™è½‰æ›å·¥å…· (Mapping Layer) ---
        const mapServerData = (serverData) => {
            if (!serverData) return { courses: [], members: [], registrations: [], categories: [] };

            const courses = (serverData.courses || []).map(c => {
                // 1. å¼·åˆ¶ä¿®æ­£ isHidden åˆ¤æ–· (è§£æ±º "FALSE" å­—ä¸²å•é¡Œ)
                let isHiddenBool = c.is_hidden;
                if (typeof isHiddenBool === 'string') {
                    isHiddenBool = isHiddenBool.toUpperCase() === 'TRUE';
                }

                return {
                    ...c,
                    id: c.course_id,
                    isHidden: !!isHiddenBool, // ç¢ºä¿è½‰ç‚ºç´” Boolean
                    // categories å’Œ sessions å·²ç¶“åœ¨å¾Œç«¯è½‰æˆé™£åˆ—äº†
                };
            });

            const members = (serverData.members || []).map(m => ({
                ...m,
                id: m.member_id,
                studentName: m.student_name,
                parentName: m.parent_name,
                idNumber: m.line_user_id,
                healthCondition: m.health_condition,
                dob: m.birthday ? new Date(m.birthday).toISOString().split('T')[0] : ''
            }));

            const registrations = (serverData.registrations || []).map(r => ({
                ...r,
                id: r.reg_id,
                courseTitle: r.course_title,
                memberName: r.member_name,
                totalPrice: r.total_price,
                sessions: r.selected_dates || []
            }));

            return {
                // 2. ä¿®æ­£æ—¥æœŸæ’åº (é˜²æ­¢ created_at ç‚ºå­—ä¸²æ™‚æ’åºå¤±æ•ˆ)
                courses: courses.sort((a, b) => {
                    const dateA = new Date(a.created_at).getTime() || 0;
                    const dateB = new Date(b.created_at).getTime() || 0;
                    return dateB - dateA; 
                }),
                members,
                registrations: registrations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)),
                categories: serverData.categories && serverData.categories.length > 0 
                            ? serverData.categories 
                            : ["å…¨éƒ¨", "çƒé¡", "æœ‰æ°§", "ç‘œçˆ", "å¥èº«", "æ°´ä¸Šé‹å‹•"]
            };
        };


        // --- UI å…ƒä»¶ ---

        const LoadingOverlay = ({ isOpen, message = "è³‡æ–™åŒæ­¥ä¸­..." }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm">
                    <div className="loader mb-4"></div>
                    <p className="text-gray-600 font-bold animate-pulse">{message}</p>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, confirmText = "ç¢ºå®š", cancelText = "å–æ¶ˆ", isDanger = false }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm relative z-10 animate-in fade-in zoom-in duration-200">
                    <div className="flex items-center gap-3 mb-3">
                        {isDanger && <div className="bg-red-100 p-2 rounded-full"><AlertTriangle className="w-6 h-6 text-red-500" /></div>}
                        <h3 className="text-lg font-bold text-gray-900">{title}</h3>
                    </div>
                    <p className="text-gray-600 mb-6 leading-relaxed whitespace-pre-line">{message}</p>
                    <div className="flex gap-3 justify-end">
                    <button onClick={onClose} className="px-5 py-2.5 rounded-xl bg-gray-100 text-gray-700 font-bold hover:bg-gray-200 transition-colors">{cancelText}</button>
                    <button onClick={onConfirm} className={`px-5 py-2.5 rounded-xl text-white font-bold shadow-lg transition-transform active:scale-95 ${isDanger ? 'bg-red-500 hover:bg-red-600 shadow-red-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'}`}>{confirmText}</button>
                    </div>
                </div>
                </div>
            );
        };

        const AlertModal = ({ isOpen, onClose, title, message }) => {
            if (!isOpen) return null;
            return (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm relative z-10 animate-in fade-in zoom-in duration-200 text-center">
                <div className="mx-auto bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mb-4"><CheckCircle className="w-8 h-8 text-green-600" /></div>
                <h3 className="text-xl font-bold text-gray-900 mb-2">{title}</h3>
                <p className="text-gray-600 mb-6 whitespace-pre-line leading-relaxed">{message}</p>
                <button onClick={onClose} className="w-full py-3 rounded-xl bg-green-600 text-white font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition-transform active:scale-95">æˆ‘çŸ¥é“äº†</button>
                </div>
            </div>
            );
        };

        // --- åŠŸèƒ½æ€§ Modals ---

        const AddMemberModal = ({ isOpen, onClose, onSubmit, data, onChange }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="bg-white w-full max-w-md h-[90vh] sm:h-auto sm:max-h-[85vh] sm:rounded-2xl rounded-t-3xl shadow-2xl z-10 flex flex-col animate-in slide-in-from-bottom duration-300">
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-green-50 sm:rounded-t-2xl rounded-t-3xl">
                            <h2 className="text-xl font-bold text-green-800 flex items-center gap-2"><UserPlus className="w-5 h-5" />æ–°å¢å­¸å“¡è³‡æ–™</h2>
                            <button onClick={onClose} className="bg-white p-1 rounded-full shadow-sm hover:bg-gray-100"><X className="w-5 h-5 text-gray-500" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 bg-white">
                            <form id="add-member-form" onSubmit={onSubmit} className="space-y-5">
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">å­¸ç”Ÿå§“å <span className="text-red-500">*</span></label><input required name="studentName" value={data.studentName} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-green-500 outline-none" placeholder="ç‹å°æ˜" /></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">æ€§åˆ¥</label><select name="gender" value={data.gender} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-green-500 outline-none"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option><option value="å…¶ä»–">å…¶ä»–</option></select></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">å®¶é•·å§“å</label><input name="parentName" value={data.parentName} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-green-500 outline-none" placeholder="ç‹å¤§å‰" /></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">èˆ‡å­¸ç”Ÿé—œä¿‚</label><input name="relationship" value={data.relationship} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-green-500 outline-none" placeholder="çˆ¶å­" /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">å‡ºç”Ÿæ—¥æœŸ <span className="text-red-500">*</span></label><input type="date" required name="dob" value={data.dob} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-green-500 outline-none" /></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1.5">èº«åˆ†è­‰å­—è™Ÿ</label><input name="idNumber" value={data.idNumber} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-green-500 outline-none" placeholder="A123..." /></div>
                                </div>
                                <div><label className="block text-sm font-bold text-gray-700 mb-1.5">å°±è®€å­¸æ ¡</label><input name="school" value={data.school} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-green-500 outline-none" placeholder="ä¾‹å¦‚ï¼šä¿¡ç¾©åœ‹å°" /></div>
                                <div><label className="block text-sm font-bold text-gray-700 mb-1.5">é€šè¨Šåœ°å€</label><input name="address" value={data.address} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-green-500 outline-none" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€" /></div>
                                <div><label className="block text-sm font-bold text-gray-700 mb-1.5">èº«é«”ç‰¹æ®Šç‹€æ³ (é¸å¡«)</label><textarea name="healthCondition" value={data.healthCondition} onChange={onChange} rows={3} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-green-500 outline-none" placeholder="ä¾‹å¦‚ï¼šæ°£å–˜ã€éæ•é£Ÿç‰©..." /></div>
                            </form>
                        </div>
                        <div className="p-4 border-t border-gray-100 bg-white sm:rounded-b-2xl">
                            <button type="submit" form="add-member-form" className="w-full bg-green-600 hover:bg-green-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-green-200 active:scale-[0.98] transition-all flex items-center justify-center gap-2"><UserPlus className="w-5 h-5" />ç¢ºèªæ–°å¢æˆå“¡</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddCourseModal = ({ isOpen, onClose, onSubmit, data, onChange, onSessionsChange, availableCategories, onAddCategory, onCategoriesChange, onDeleteCategory }) => {
            if (!isOpen) return null;
            const [genStartDate, setGenStartDate] = useState("");
            const [genDays, setGenDays] = useState(10);
            const [singleDate, setSingleDate] = useState("");
            const [newCategoryInput, setNewCategoryInput] = useState("");

            const handleGenerateDates = () => {
                if (!genStartDate) return alert("è«‹é¸æ“‡èµ·å§‹æ—¥æœŸ");
                const dates = [];
                let currentDate = new Date(genStartDate);
                for (let i = 0; i < genDays; i++) {
                    dates.push(currentDate.toISOString().split('T')[0]);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                const newSessions = Array.from(new Set([...data.sessions, ...dates])).sort();
                onSessionsChange(newSessions);
            };

            const handleAddSingleDate = () => {
                if (!singleDate) return;
                if (!data.sessions.includes(singleDate)) {
                    const newSessions = [...data.sessions, singleDate].sort();
                    onSessionsChange(newSessions);
                }
                setSingleDate("");
            };
            const removeSession = (dateToRemove) => {
                onSessionsChange(data.sessions.filter(d => d !== dateToRemove));
            };

            const toggleCategory = (cat) => {
                const currentCats = data.categories || [];
                if (currentCats.includes(cat)) {
                    onCategoriesChange(currentCats.filter(c => c !== cat));
                } else {
                    onCategoriesChange([...currentCats, cat]);
                }
            };
            const handleAddNewCategory = () => {
                const trimmedCat = newCategoryInput.trim();
                if (!trimmedCat) return;
                onAddCategory(trimmedCat); 
                setNewCategoryInput("");
            };

            return (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
                <div className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                <div className="bg-white w-full max-w-md h-[90vh] sm:h-auto sm:max-h-[85vh] sm:rounded-2xl rounded-t-3xl shadow-2xl z-10 flex flex-col animate-in slide-in-from-bottom duration-300">
                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-blue-50 sm:rounded-t-2xl rounded-t-3xl">
                    <h2 className="text-xl font-bold text-blue-800 flex items-center gap-2"><Plus className="w-5 h-5" />æ–°å¢èª²ç¨‹</h2>
                    <button onClick={onClose} className="bg-white p-1 rounded-full shadow-sm hover:bg-gray-100"><X className="w-5 h-5 text-gray-500" /></button>
                </div>
                <div className="flex-1 overflow-y-auto p-6 bg-white">
                    <form id="add-course-form" onSubmit={onSubmit} className="space-y-5">
                        <div><label className="block text-sm font-bold text-gray-700 mb-1.5">èª²ç¨‹åç¨± <span className="text-red-500">*</span></label><input required name="title" value={data.title} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šé€²éšæ”å½±ç­" /></div>
                        
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-2">èª²ç¨‹åˆ†é¡ (å¯å¤šé¸) <span className="text-red-500">*</span></label>
                            <div className="flex flex-wrap gap-2 mb-3">
                                {availableCategories.filter(c => c !== "å…¨éƒ¨").map(cat => {
                                    const isSelected = data.categories.includes(cat);
                                    return (
                                        <div key={cat} onClick={() => toggleCategory(cat)} className={`inline-flex items-center px-3 py-1.5 rounded-full text-sm border transition-all cursor-pointer ${isSelected ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'bg-white text-gray-600 border-gray-200 hover:border-blue-300'}`}>
                                            <span>{cat}</span>
                                            <button type="button" onClick={(e) => { e.stopPropagation(); onDeleteCategory(cat); }} className={`ml-2 p-0.5 rounded-full hover:bg-black/10 ${isSelected ? 'text-white' : 'text-gray-400'}`}>
                                                <X className="w-3 h-3" />
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                            <div className="flex gap-2">
                                <input value={newCategoryInput} onChange={(e) => setNewCategoryInput(e.target.value)} placeholder="è¼¸å…¥æ–°åˆ†é¡..." className="flex-1 p-2 bg-gray-50 rounded-lg border border-gray-200 text-sm focus:border-blue-500 outline-none"/>
                                <button type="button" onClick={handleAddNewCategory} className="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-bold hover:bg-gray-200"><Plus className="w-4 h-4" /></button>
                            </div>
                        </div>

                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-3">
                            <label className="block text-sm font-bold text-gray-700">èª²ç¨‹å ´æ¬¡è¨­å®š <span className="text-red-500">*</span></label>
                            <div className="flex gap-2 items-end">
                                <div className="flex-1"><span className="text-xs text-gray-500 mb-1 block">èµ·å§‹æ—¥</span><input type="date" value={genStartDate} onChange={(e) => setGenStartDate(e.target.value)} className="w-full p-2 bg-white rounded-lg border border-gray-300 text-sm" /></div>
                                <div className="w-20"><span className="text-xs text-gray-500 mb-1 block">å¤©æ•¸</span><input type="number" min="1" value={genDays} onChange={(e) => setGenDays(e.target.value)} className="w-full p-2 bg-white rounded-lg border border-gray-300 text-sm" /></div>
                                <button type="button" onClick={handleGenerateDates} className="bg-blue-100 text-blue-700 p-2 rounded-lg text-sm font-bold hover:bg-blue-200 whitespace-nowrap">ç”Ÿæˆ</button>
                            </div>
                            <div className="flex gap-2 items-center pt-2 border-t border-gray-200">
                                <span className="text-xs text-gray-500">æ‰‹å‹•åŠ é–‹ï¼š</span>
                                <input type="date" value={singleDate} onChange={(e) => setSingleDate(e.target.value)} className="p-1 bg-white rounded border border-gray-300 text-sm" />
                                <button type="button" onClick={handleAddSingleDate} className="text-green-600 font-bold text-sm hover:underline">æ–°å¢</button>
                            </div>
                            <div className="flex flex-wrap gap-2 mt-2 max-h-32 overflow-y-auto">
                                {data.sessions.length === 0 && <span className="text-gray-400 text-sm">å°šæœªè¨­å®šæ—¥æœŸ</span>}
                                {data.sessions.map((date) => (
                                    <span key={date} className="bg-white border border-gray-200 text-gray-700 px-2 py-1 rounded-md text-sm flex items-center gap-1">{date}<button type="button" onClick={() => removeSession(date)} className="text-red-400 hover:text-red-600"><X className="w-3 h-3" /></button></span>
                                ))}
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-sm font-bold text-gray-700 mb-1.5">æ™‚é–“ <span className="text-red-500">*</span></label><input required name="time" value={data.time} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-blue-500 outline-none" placeholder="14:00" /></div>
                            <div><label className="block text-sm font-bold text-gray-700 mb-1.5">åƒ¹æ ¼ (å–®å ‚/å…¨æœŸ) <span className="text-red-500">*</span></label><input required type="number" name="price" value={data.price} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-blue-500 outline-none" placeholder="0" /></div>
                        </div>
                        <div><label className="block text-sm font-bold text-gray-700 mb-1.5">åœ°é» <span className="text-red-500">*</span></label><input required name="location" value={data.location} onChange={onChange} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-blue-500 outline-none" placeholder="åœ°é»" /></div>
                        <div><label className="block text-sm font-bold text-gray-700 mb-1.5">èª²ç¨‹è©³ç´°è³‡è¨Š <span className="text-red-500">*</span></label><textarea required name="description" value={data.description} onChange={onChange} rows={5} className="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:border-blue-500 outline-none" placeholder="èª²ç¨‹å¤§ç¶±..." /></div>
                    </form>
                </div>
                <div className="p-4 border-t border-gray-100 bg-white sm:rounded-b-2xl">
                    <button type="submit" form="add-course-form" className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-[0.98] transition-all flex items-center justify-center gap-2"><Plus className="w-5 h-5" />ç¢ºèªæ–°å¢èª²ç¨‹</button>
                </div>
                </div>
            </div>
            );
        };

        const CourseDetailModal = ({ course, onClose, isAdmin, onRegister, members, onAlert }) => {
            if (!course) return null;
            const [selectedDates, setSelectedDates] = useState([]);
            const [selectedMemberId, setSelectedMemberId] = useState("");
            useEffect(() => {
                if (course.sessions && course.sessions.length === 1) {
                    setSelectedDates([course.sessions[0]]);
                } else {
                    setSelectedDates([]);
                }
                setSelectedMemberId("");
            }, [course]);
            const toggleDate = (date) => {
                if (selectedDates.includes(date)) {
                    setSelectedDates(selectedDates.filter(d => d !== date));
                } else {
                    setSelectedDates([...selectedDates, date].sort());
                }
            };
            const handleConfirmRegister = () => {
                if (selectedDates.length === 0) {
                    onAlert("è«‹æ³¨æ„", "è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ä¸Šèª²æ—¥æœŸ");
                    return;
                }
                if (!isAdmin) {
                    if (!selectedMemberId) {
                        onAlert("è«‹æ³¨æ„", "è«‹é¸æ“‡ä¸€ä½è¦å ±åçš„å­¸å“¡");
                        return;
                    }
                    const member = members.find(m => m.id === Number(selectedMemberId));
                    onRegister(course, selectedDates, member);
                } else {
                    onAlert("ç®¡ç†å“¡æ¨¡å¼", "ç®¡ç†å“¡åƒ…ä¾›é è¦½ï¼Œç„¡æ³•å ±å");
                }
            };
            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto transition-opacity" onClick={onClose}></div>
                    <div className="bg-white w-full max-w-md h-[85vh] sm:h-auto sm:max-h-[85vh] sm:rounded-2xl rounded-t-3xl shadow-2xl pointer-events-auto flex flex-col relative animate-in slide-in-from-bottom duration-300">
                        <button onClick={onClose} className="absolute top-4 right-4 z-10 bg-black/20 hover:bg-black/30 text-white rounded-full p-1"><X className="w-5 h-5" /></button>
                        <div className="h-56 flex-shrink-0 relative">
                            <img src={course.image} alt={course.title} className="w-full h-full object-cover rounded-t-3xl sm:rounded-t-2xl" />
                            <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-6 pt-12">
                                <div className="flex flex-wrap gap-1 mb-2">
                                    {course.categories && course.categories.map(cat => (
                                        <span key={cat} className="bg-green-500/90 backdrop-blur-sm text-white text-xs font-bold px-2 py-1 rounded-md shadow-sm">{cat}</span>
                                    ))}
                                </div>
                                <h2 className="text-2xl font-bold text-white leading-tight">{course.title}</h2>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="space-y-4">
                                <div className="flex items-center gap-3 text-gray-600"><Calendar className="w-5 h-5 text-green-500" /><span>{course.sessions && course.sessions.length > 0 ? `${course.sessions[0]} èµ· (å…± ${course.sessions.length} å ‚)` : "å°šæœªè¨­å®šæ—¥æœŸ"}</span></div>
                                <div className="flex items-center gap-3 text-gray-600"><Clock className="w-5 h-5 text-green-500" /><span>{course.time}</span></div>
                                <div className="flex items-center gap-3 text-gray-600"><MapPin className="w-5 h-5 text-green-500" /><span>{course.location}</span></div>
                                {!isAdmin && course.sessions && course.sessions.length > 0 && (
                                    <>
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mt-2">
                                            <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><UserCircle className="w-4 h-4" />é¸æ“‡ä¸Šèª²å­¸å“¡</h3>
                                            {members && members.length === 0 ? (
                                                <div className="text-sm text-gray-500 text-center py-3 bg-white rounded-lg border border-dashed border-gray-200">å°šç„¡æˆå“¡è³‡æ–™ï¼Œè«‹å…ˆè‡³ã€Œæˆå“¡ã€é é¢æ–°å¢</div>
                                            ) : (
                                                <div className="space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                                                    {members.map(member => (
                                                        <label key={member.id} className={`flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${Number(selectedMemberId) === member.id ? 'bg-blue-600 text-white border-blue-600 shadow-md transform scale-[1.01]' : 'bg-white text-gray-600 border-gray-200 hover:border-blue-300'}`}>
                                                            <div className="flex items-center gap-3">
                                                                <input type="radio" name="memberSelect" className="hidden" value={member.id} checked={Number(selectedMemberId) === member.id} onChange={(e) => setSelectedMemberId(e.target.value)} />
                                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${Number(selectedMemberId) === member.id ? 'bg-white/20 text-white' : 'bg-blue-100 text-blue-600'}`}>{member.studentName.charAt(0)}</div>
                                                                <div className="flex flex-col"><span className="font-bold">{member.studentName}</span><span className={`text-xs ${Number(selectedMemberId) === member.id ? 'text-blue-100' : 'text-gray-400'}`}>{member.relationship}</span></div>
                                                            </div>
                                                            {Number(selectedMemberId) === member.id && <CheckCircle className="w-5 h-5" />}
                                                        </label>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-xl border border-green-100 mt-2">
                                            <h3 className="font-bold text-green-800 mb-2 flex items-center gap-2"><CheckSquare className="w-4 h-4" />é¸æ“‡åƒåŠ å ´æ¬¡</h3>
                                            <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                                                {course.sessions.map(date => (
                                                    <label key={date} className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer transition-all ${selectedDates.includes(date) ? 'bg-green-500 text-white border-green-600 shadow-sm' : 'bg-white text-gray-600 border-gray-200 hover:border-green-300'}`}>
                                                        <input type="checkbox" className="hidden" checked={selectedDates.includes(date)} onChange={() => toggleDate(date)} />
                                                        <span className="text-sm font-medium">{date}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            <div className="mt-2 text-xs text-green-700 text-right">å·²é¸æ“‡ {selectedDates.length} å ‚èª²</div>
                                        </div>
                                    </>
                                )}
                                <div className="pt-4 border-t border-gray-100"><h3 className="font-bold text-gray-800 mb-2">èª²ç¨‹è©³æƒ…</h3><p className="text-gray-600 leading-relaxed whitespace-pre-line">{course.description}</p></div>
                            </div>
                        </div>
                        <div className="p-4 border-t border-gray-100 bg-white sm:rounded-b-2xl pb-8 sm:pb-4">
                            <div className="flex items-center justify-between mb-4"><span className="text-gray-500 text-sm">å ±åè²»ç”¨</span><span className="text-2xl font-bold text-green-600">NT${course.price * (selectedDates.length || 1)}</span></div>
                            {isAdmin ? (
                                <div className="grid grid-cols-2 gap-3">
                                    <button className="bg-gray-100 text-gray-700 py-3 rounded-xl font-bold">é è¦½å­¸å“¡åå–®</button>
                                    <button className="bg-blue-600 text-white py-3 rounded-xl font-bold">ç·¨è¼¯å…§å®¹</button>
                                </div>
                            ) : (
                                <button onClick={handleConfirmRegister} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-200 active:scale-[0.98] transition-all">{selectedDates.length > 0 ? `ç¢ºèªå ±å (${selectedDates.length}å ‚)` : "è«‹é¸æ“‡å ´æ¬¡"}</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ä¸»è¦é é¢ Views ---

        const HomeView = ({ courses, allCategories, isAdmin, searchTerm, setSearchTerm, selectedCategory, setSelectedCategory, onSelectCourse, onAddCourseClick, onToggleHide, onDeleteCourse }) => {
            const filteredCourses = courses.filter(course => {
                const matchesSearch = course.title.includes(searchTerm) || course.location.includes(searchTerm);
                const matchesCategory = selectedCategory === "å…¨éƒ¨" || (course.categories && course.categories.includes(selectedCategory));
                const matchesVisibility = isAdmin ? true : !course.isHidden; // Admin çœ‹å¾—åˆ°æ‰€æœ‰
                const matchesHiddenFilter = isAdmin ? !course.isHidden : true; // Admin åœ¨ä¸»é åªçœ‹æœªéš±è—çš„ï¼Œéš±è—çš„åœ¨æ­·å²å€
                return matchesSearch && matchesCategory && matchesVisibility && matchesHiddenFilter;
            });

            console.log("æ‰€æœ‰èª²ç¨‹åŸå§‹è³‡æ–™:", courses);
            console.log("éæ¿¾å¾Œçš„èª²ç¨‹:", filteredCourses);

            return (
                <div className="pb-24 md:pb-8">
                    <header className="md:hidden bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-b-3xl shadow-lg relative">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <img src="https://lihi.cc/dXsA6" alt="Logo" className="w-12 h-12 rounded-full border-2 border-white shadow-sm object-cover" />
                                <div><h1 className="text-2xl font-bold">é‹å‹•å³¶å ±åç³»çµ±</h1><p className="text-sm opacity-90 mt-1">å¥åº·ç”Ÿæ´»ï¼Œå¿«æ¨‚é‹å‹•</p></div>
                            </div>
                        </div>
                    </header>
                    <div className="hidden md:block px-4 py-6">
                        <h1 className="text-3xl font-bold text-gray-800">ç†±é–€èª²ç¨‹</h1>
                        <p className="text-gray-500 mt-1">é¸æ“‡æ‚¨æ„Ÿèˆˆè¶£çš„èª²ç¨‹é–‹å§‹å­¸ç¿’</p>
                    </div>
                    <section className="px-4 mt-6 md:mt-2">
                        <div className="relative">
                            <input type="text" placeholder="æœå°‹èª²ç¨‹åç¨±ã€åœ°é»..." className="w-full pl-4 pr-4 py-3 rounded-xl bg-gray-100 border-none focus:ring-2 focus:ring-green-400 outline-none text-gray-700" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                        </div>
                        <div className="flex gap-2 overflow-x-auto mt-4 pb-2 no-scrollbar">{allCategories.map(cat => (<button key={cat} onClick={() => setSelectedCategory(cat)} className={`whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${selectedCategory === cat ? 'bg-green-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200'}`}>{cat}</button>))}</div>
                    </section>
                    {isAdmin && (
                        <section className="px-4 mt-4 mb-2"><button onClick={onAddCourseClick} className="w-full flex items-center justify-center gap-2 bg-blue-50 text-blue-600 border border-blue-200 py-3 rounded-xl font-medium active:scale-95 transition-transform hover:bg-blue-100"><Plus className="w-5 h-5" />æ–°å¢èª²ç¨‹</button></section>
                    )}
                    <section className="px-4 mt-4 space-y-4 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-6">
                        {filteredCourses.length === 0 ? (
                            <div className="text-center py-10 text-gray-400 col-span-full"><p>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„èª²ç¨‹</p></div>
                        ) : (
                            filteredCourses.map(course => (
                                <div key={course.id} onClick={() => onSelectCourse(course)} className={`bg-white rounded-2xl shadow-sm border overflow-hidden cursor-pointer active:opacity-90 transition-all hover:shadow-md ${course.isHidden ? 'opacity-60 border-dashed border-gray-400' : 'border-gray-100'}`}>
                                    <div className="relative h-48 w-full md:h-40">
                                        <img src={course.image} alt={course.title} className="w-full h-full object-cover" />
                                        <div className="absolute top-2 right-2 flex gap-1">{course.categories && course.categories.slice(0, 2).map(cat => (<div key={cat} className="bg-white/90 backdrop-blur-sm px-2 py-1 rounded-md text-xs font-bold text-gray-700 shadow-sm">{cat}</div>))}{course.categories && course.categories.length > 2 && (<div className="bg-white/90 backdrop-blur-sm px-2 py-1 rounded-md text-xs font-bold text-gray-700 shadow-sm">+{course.categories.length - 2}</div>)}</div>
                                    </div>
                                    <div className="p-4">
                                        <div className="flex justify-between items-start"><h3 className="font-bold text-lg text-gray-800 line-clamp-1">{course.title}</h3><span className="text-green-600 font-bold">NT${course.price}</span></div>
                                        <div className="mt-3 space-y-1 text-sm text-gray-500">
                                            <div className="flex items-center gap-2"><Calendar className="w-4 h-4" /><span>{course.sessions && course.sessions.length > 0 ? `${course.sessions[0]} (å…±${course.sessions.length}å ‚)` : "æœªå®š"}</span></div>
                                            <div className="flex items-center gap-2"><MapPin className="w-4 h-4" /><span>{course.location}</span></div>
                                        </div>
                                        {isAdmin && (
                                            <div className="mt-4 pt-3 border-t border-gray-100 flex justify-end gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); alert('é–‹å•Ÿç·¨è¼¯ç•«é¢'); }} className="p-2 bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200"><Edit className="w-4 h-4" /></button>
                                                <button onClick={(e) => { e.stopPropagation(); onToggleHide(course.id); }} className={`p-2 rounded-lg bg-gray-100 text-gray-600`}><EyeOff className="w-4 h-4" /></button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))
                        )}
                    </section>
                </div>
            );
        };

        const RecordsView = ({ registrations, onPayment, goToCourses }) => {
            return (
                <div className="p-4 pb-24 md:max-w-2xl md:mx-auto md:mt-8">
                    <h1 className="text-2xl font-bold mb-6">æˆ‘çš„å ±åç´€éŒ„</h1>
                    {registrations.length === 0 ? (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-center">
                            <ClipboardList className="w-12 h-12 text-gray-300 mx-auto mb-4" />
                            <p className="text-gray-500">å°šç„¡å ±åä¸­çš„èª²ç¨‹</p>
                            <button onClick={goToCourses} className="mt-4 text-green-600 font-medium">å»ç€è¦½èª²ç¨‹</button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {registrations.map(reg => (
                                <div key={reg.id} className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                                    <div className="flex justify-between items-start mb-2">
                                        <h3 className="font-bold text-gray-800">{reg.courseTitle}</h3>
                                        <span className={`text-xs px-2 py-1 rounded-full font-bold ${reg.status === 'paid' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'}`}>
                                            {reg.status === 'paid' ? 'å·²ç¹³è²»' : 'å°šæœªç¹³è²»'}
                                        </span>
                                    </div>
                                    <div className="text-sm text-gray-500 space-y-1 mb-3">
                                        <div className="flex items-center gap-2"><UserCircle className="w-4 h-4" /> å­¸å“¡ï¼š{reg.memberName}</div>
                                        <div className="flex items-center gap-2"><MapPin className="w-4 h-4" /> åœ°é»è©³è¦‹èª²ç¨‹</div>
                                        <div className="flex items-start gap-2">
                                            <Calendar className="w-4 h-4 mt-0.5" /> 
                                            <span>{reg.sessions && reg.sessions.length > 3 ? `${reg.sessions[0]}...ç­‰ ${reg.sessions.length} å€‹å ´æ¬¡` : (reg.sessions || []).join(", ")}</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center justify-between pt-3 border-t border-gray-50">
                                        <div className="flex flex-col"><span className="text-xs text-gray-400">ç¸½é‡‘é¡</span><span className="font-bold text-lg text-gray-800">NT${reg.totalPrice}</span></div>
                                        {reg.status === 'unpaid' && (
                                            <button onClick={() => onPayment(reg.id)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-green-100 flex items-center gap-1 active:scale-95 transition-all"><CreditCard className="w-4 h-4" /> å‰å¾€ç¹³è²»</button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const MembersView = ({ isAdmin, members, courses, onDeleteMember, onAddMemberClick, onToggleHideCourse, onDeleteCourse }) => {
            const [view, setView] = useState('menu');
            const [historySearchTerm, setHistorySearchTerm] = useState("");
            
            if (isAdmin && view === 'history') {
                const hiddenCourses = courses.filter(c => c.isHidden && c.title.includes(historySearchTerm));
                return (
                    <div className="pb-24 flex flex-col min-h-screen bg-gray-50 md:max-w-2xl md:mx-auto">
                        <div className="bg-white px-4 py-4 border-b border-gray-100 flex items-center gap-2 sticky top-0 z-10 shadow-sm md:rounded-b-2xl">
                            <button onClick={() => setView('menu')} className="p-2 rounded-full hover:bg-gray-100"><ArrowLeft className="w-6 h-6 text-gray-600" /></button>
                            <h2 className="text-lg font-bold text-gray-800">æ­·å²èª²ç¨‹ç´€éŒ„ (å·²éš±è—)</h2>
                        </div>
                        <div className="p-4">
                            <div className="relative mb-4">
                                <input type="text" placeholder="æœå°‹æ­·å²èª²ç¨‹..." className="w-full pl-10 pr-4 py-2.5 rounded-xl bg-white border border-gray-200 focus:ring-2 focus:ring-gray-300 outline-none text-gray-700" value={historySearchTerm} onChange={(e) => setHistorySearchTerm(e.target.value)} />
                                <Search className="w-4 h-4 text-gray-400 absolute left-3 top-3.5" />
                            </div>
                            <div className="space-y-3">
                                {hiddenCourses.length === 0 ? (
                                    <div className="text-center py-10 text-gray-400"><p>æ²’æœ‰ç¬¦åˆçš„æ­·å²èª²ç¨‹</p></div>
                                ) : (
                                    hiddenCourses.map(course => (
                                        <div key={course.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                                            <div className="flex-1 min-w-0 pr-3">
                                                <h3 className="font-bold text-gray-800 truncate">{course.title}</h3>
                                                <div className="text-xs text-gray-500 mt-1 flex gap-2"><span>{course.sessions[0]}</span><span className="bg-gray-100 px-1 rounded">{course.location}</span></div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <button onClick={(e) => {e.stopPropagation(); onToggleHideCourse(course.id);}} className="p-2 bg-green-50 text-green-600 rounded-lg text-xs font-bold hover:bg-green-100">é‚„åŸ</button>
                                                <button onClick={(e) => {e.stopPropagation(); onDeleteCourse(course.id);}} className="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100"><Trash2 className="w-4 h-4" /></button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="pb-24 md:max-w-2xl md:mx-auto">
                    <div className="bg-gradient-to-b from-green-500 to-green-400 text-white pt-10 pb-20 px-6 rounded-b-[40px] text-center shadow-lg md:rounded-b-3xl md:pt-12 md:pb-24">
                        <div className="w-20 h-20 bg-white/20 rounded-full mx-auto flex items-center justify-center mb-4 backdrop-blur-sm border-2 border-white/30"><UserCircle className="w-12 h-12 text-white" /></div>
                        <h2 className="text-xl font-bold">ä½¿ç”¨è€…åç¨±</h2>
                        <p className="opacity-80 text-sm mt-1">{isAdmin ? 'ç³»çµ±ç®¡ç†å“¡' : 'ä¸€èˆ¬æœƒå“¡'}</p>
                    </div>
                    <div className="px-4 -mt-10 space-y-4">
                        {!isAdmin && (
                            <div className="bg-white rounded-2xl shadow-md p-4">
                                <div className="flex justify-between items-center mb-3"><h3 className="font-bold text-gray-800 flex items-center gap-2"><Baby className="w-5 h-5 text-green-600" />æˆ‘çš„å­¸å“¡/å­å¥³</h3><button onClick={onAddMemberClick} className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-md font-bold hover:bg-green-200 flex items-center gap-1"><Plus className="w-3 h-3" /> æ–°å¢</button></div>
                                <div className="space-y-3">
                                    {members.length === 0 ? (<div className="text-center py-4 text-gray-400 text-sm bg-gray-50 rounded-lg border border-dashed border-gray-200">å°šç„¡å»ºç«‹è³‡æ–™ï¼Œè«‹é»æ“Šæ–°å¢</div>) : (members.map(member => (
                                        <div key={member.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                                            <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">{member.studentName.charAt(0)}</div><div><div className="font-bold text-gray-800">{member.studentName}</div><div className="text-xs text-gray-500 flex items-center gap-2"><span className="bg-white px-1 rounded border border-gray-200">{member.relationship}</span>{member.school && <span className="flex items-center gap-0.5"><School className="w-3 h-3" /> {member.school}</span>}</div></div></div>
                                            <button onClick={() => onDeleteMember(member.id)} className="text-red-400 p-2 hover:bg-red-50 rounded-full"><Trash2 className="w-4 h-4" /></button>
                                        </div>
                                    )))}
                                </div>
                            </div>
                        )}
                        <div className="bg-white rounded-2xl shadow-md p-2 overflow-hidden">
                            {isAdmin ? (
                                <>
                                    <div className="p-4 border-b border-gray-50 flex items-center gap-3"><div className="bg-blue-100 p-2 rounded-lg"><Users className="w-5 h-5 text-blue-600" /></div><span className="font-medium text-gray-700">æœƒå“¡ç®¡ç†</span></div>
                                    <div className="p-4 border-b border-gray-50 flex items-center gap-3"><div className="bg-purple-100 p-2 rounded-lg"><ClipboardList className="w-5 h-5 text-purple-600" /></div><span className="font-medium text-gray-700">å…¨ç«™å ±åæ¸…å–®</span></div>
                                    <div onClick={() => setView('history')} className="p-4 border-b border-gray-50 flex items-center gap-3 cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition-colors">
                                        <div className="bg-gray-100 p-2 rounded-lg"><History className="w-5 h-5 text-gray-600" /></div>
                                        <div className="flex-1 flex justify-between items-center">
                                            <span className="font-medium text-gray-700">æ­·å²èª²ç¨‹ç´€éŒ„ (å·²éš±è—)</span>
                                            <span className="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded-full">{courses.filter(c => c.isHidden).length}</span>
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <div className="p-4 border-b border-gray-50 flex items-center gap-3"><div className="bg-green-100 p-2 rounded-lg"><CheckCircle className="w-5 h-5 text-green-600" /></div><span className="font-medium text-gray-700">å·²å®Œæˆèª²ç¨‹</span></div>
                                    <div className="p-4 border-b border-gray-50 flex items-center gap-3"><div className="bg-orange-100 p-2 rounded-lg"><ShieldCheck className="w-5 h-5 text-orange-600" /></div><span className="font-medium text-gray-700">éš±ç§æ¬Šè¨­å®š</span></div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // â˜…â˜…â˜… æ–°å¢ï¼šç®¡ç†å“¡å¯†ç¢¼è¼¸å…¥è¦–çª— â˜…â˜…â˜…
        const AdminAuthModal = ({ isOpen, onClose, onSubmit }) => {
            if (!isOpen) return null;
            const [password, setPassword] = useState("");
            
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
                    <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-xs relative z-10 animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-900">ç®¡ç†å“¡èªè­‰</h3>
                            <button onClick={onClose}><X className="w-5 h-5 text-gray-400" /></button>
                        </div>
                        <p className="text-sm text-gray-500 mb-4 text-center">è«‹è¼¸å…¥ç®¡ç†å“¡é‡‘é‘°ä»¥å•Ÿç”¨é€²éšåŠŸèƒ½</p>
                        <input 
                            type="password" 
                            className="w-full p-3 bg-gray-100 rounded-xl border border-gray-200 outline-none text-center tracking-widest mb-4 focus:ring-2 focus:ring-blue-500 font-bold text-xl" 
                            placeholder="â—â—â—â—"
                            autoFocus
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                        />
                        <button 
                            onClick={() => onSubmit(password)} 
                            className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-all"
                        >
                            é©—è­‰èº«åˆ†
                        </button>
                    </div>
                </div>
            );
        };

        function App() {
            // 0. å®šç¾©å¸¸æ•¸
            const DEFAULT_CATEGORIES = ["å…¨éƒ¨", "çƒé¡", "æœ‰æ°§", "ç‘œçˆ", "å¥èº«", "æ°´ä¸Šé‹å‹•"];

            // 1. App UI ç‹€æ…‹
            const [activeTab, setActiveTab] = useState('courses');
            const [isAdmin, setIsAdmin] = useState(false);
            const [isAdminAuthOpen, setIsAdminAuthOpen] = useState(false); // â˜… æ–°å¢ï¼šæ§åˆ¶å¯†ç¢¼æ¡†
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedCategory, setSelectedCategory] = useState("å…¨éƒ¨");
            const [allCategories, setAllCategories] = useState(DEFAULT_CATEGORIES);
            const [isLoading, setIsLoading] = useState(true);

            // 2. ä½¿ç”¨è€…ç‹€æ…‹
            const [liffError, setLiffError] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);

            // 3. è³‡æ–™ç‹€æ…‹
            const [courses, setCourses] = useState([]);
            const [members, setMembers] = useState([]);
            const [registrations, setRegistrations] = useState([]);

            // 4. Modals
            const [selectedCourse, setSelectedCourse] = useState(null);
            const [isAddingCourse, setIsAddingCourse] = useState(false);
            const [isAddingMember, setIsAddingMember] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: "", message: "", onConfirm: null, isDanger: false });
            const [alertModal, setAlertModal] = useState({ isOpen: false, title: "", message: "" });
            
            // 5. è¡¨å–®æš«å­˜
            const [newCourseData, setNewCourseData] = useState({ title: "", sessions: [], time: "", location: "", price: "", description: "", categories: [] });
            const [newMemberData, setNewMemberData] = useState({ studentName: "", parentName: "", relationship: "", gender: "ç”·", dob: "", idNumber: "", address: "", school: "", healthCondition: "" });

            // --- åˆå§‹åŒ– LIFF ---
            useEffect(() => {
                const initLiff = async () => {
                    try {
                        await liff.init({ liffId: MY_LIFF_ID });
                        if (liff.isLoggedIn()) {
                            const profile = await liff.getProfile();
                            console.log("LINE Profile:", profile);
                            setCurrentUser({
                                userId: profile.userId,
                                displayName: profile.displayName,
                                pictureUrl: profile.pictureUrl
                            });
                            // â˜… å‚³é€ userId çµ¦å¾Œç«¯é€²è¡Œæ¬Šé™åˆ¤æ–·
                            fetchData(profile.userId); 
                        } else {
                            setIsLoading(false);
                        }
                    } catch (err) {
                        console.error("LIFF Init Error:", err);
                        setLiffError(err.toString());
                        setIsLoading(false);
                    }
                };
                initLiff();
            }, []);

            // --- æ ¸å¿ƒï¼šæŠ“å–è³‡æ–™ (æ¬Šé™ç‰ˆ) ---
            const fetchData = async (userId) => {
                setIsLoading(true);
                try {
                    // â˜… é€™è£¡æ”¹ç”¨äº† callApi ä¸¦å¸¶å…¥ userId
                    const data = await callApi('getSystemData', { userId: userId });
                    const mapped = mapServerData(data);
                    
                    setCourses(mapped.courses);
                    setMembers(mapped.members);
                    setRegistrations(mapped.registrations);
                    if (mapped.categories.length > 0) setAllCategories(mapped.categories);
                    
                    // â˜… é—œéµï¼šå¾Œç«¯å‘Šè¨´å‰ç«¯æ˜¯å¦ç‚ºç®¡ç†å“¡
                    if (data.userStatus && data.userStatus.isAdmin) {
                        setIsAdmin(true);
                    }
                } catch (err) {
                    alert("è®€å–è³‡æ–™å¤±æ•—: " + err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // --- æ ¸å¿ƒï¼šç®¡ç†å“¡é©—è­‰ ---
            const handleAdminAuth = async (password) => {
                if(!password) return;
                setIsAdminAuthOpen(false); // å…ˆé—œè¦–çª—
                setIsLoading(true);
                
                try {
                    const data = await callApi('apiVerifyAdmin', { 
                        userId: currentUser.userId, 
                        password: password 
                    });
                    
                    const mapped = mapServerData(data);
                    setCourses(mapped.courses);
                    setMembers(mapped.members);
                    setRegistrations(mapped.registrations);
                    
                    if (data.userStatus && data.userStatus.isAdmin) {
                        setIsAdmin(true);
                        showAlert("æ­¡è¿å›ä¾†", "ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿç”¨");
                    } else {
                        showAlert("é©—è­‰å¤±æ•—", "é‡‘é‘°éŒ¯èª¤");
                    }
                } catch (err) {
                    alert("é©—è­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤: " + err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // --- é€šç”¨ Server Action ---
            const handleServerAction = async (actionName, payload, successMsg) => {
                setIsLoading(true);
                try {
                    // ç¢ºä¿æ‰€æœ‰å‹•ä½œéƒ½å¸¶ä¸Šç•¶å‰ userIdï¼Œä»¥å…æ“ä½œå¾Œæ¬Šé™ä¸Ÿå¤±
                    const fullPayload = (typeof payload === 'object') ? 
                        { ...payload, userId: currentUser?.userId } : payload;

                    const data = await callApi(actionName, fullPayload);
                    const mapped = mapServerData(data);
                    
                    setCourses(mapped.courses);
                    setMembers(mapped.members);
                    setRegistrations(mapped.registrations);
                    if (mapped.categories.length > 0) setAllCategories(mapped.categories);
                    
                    if (successMsg) showAlert("æˆåŠŸ", successMsg);
                } catch (err) {
                    alert("æ“ä½œå¤±æ•—: " + err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // --- Handlers ---
            const showAlert = (title, message) => setAlertModal({ isOpen: true, title, message });
            const showConfirm = (title, message, onConfirm, isDanger = false) => setConfirmModal({ isOpen: true, title, message, onConfirm, isDanger });

            const addGlobalCategory = (cat) => handleServerAction('apiAddCategory', cat, null);
            const deleteGlobalCategory = (cat) => handleServerAction('apiDeleteCategory', cat, null);
            const toggleHideCourse = (id) => handleServerAction('apiToggleHideCourse', id, null);
            const handlePayment = (regId) => handleServerAction('apiPayRegistration', regId, "æ‚¨å·²å®Œæˆç¹³è²»ï¼");
            
            const handleSubmitNewCourse = (e) => {
                e.preventDefault();
                if (!newCourseData.title) return showAlert("éŒ¯èª¤", "è«‹å¡«å¯«èª²ç¨‹åç¨±");
                
                const randomColor = Math.floor(Math.random()*16777215).toString(16);
                const payload = {
                    ...newCourseData,
                    image: `https://placehold.co/600x300/${randomColor}/white?text=${encodeURIComponent(newCourseData.title.slice(0, 4))}`,
                    categories: newCourseData.categories.length > 0 ? newCourseData.categories : ["å…¶ä»–"]
                };
                handleServerAction('apiAddCourse', payload, "èª²ç¨‹æ–°å¢æˆåŠŸï¼");
                setIsAddingCourse(false);
                setNewCourseData({ title: "", sessions: [], time: "", location: "", price: "", description: "", categories: [] });
            };

            const handleDeleteCourse = (id) => {
                showConfirm("ç¢ºå®šåˆªé™¤ï¼Ÿ", "æ­¤æ“ä½œç„¡æ³•å¾©åŸ", () => {
                    handleServerAction('apiDeleteCourse', id, "èª²ç¨‹å·²åˆªé™¤");
                    setConfirmModal(prev => ({ ...prev, isOpen: false }));
                }, true);
            };

            const handleSubmitNewMember = (e) => {
                e.preventDefault();
                const payload = {
                    ...newMemberData,
                    line_user_id: currentUser ? currentUser.userId : 'guest' 
                };
                handleServerAction('apiAddMember', payload, "æˆå“¡æ–°å¢æˆåŠŸï¼");
                setIsAddingMember(false);
                setNewMemberData({ studentName: "", parentName: "", relationship: "", gender: "ç”·", dob: "", idNumber: "", address: "", school: "", healthCondition: "" });
            };

            const handleDeleteMember = (id) => {
                 alert("ç‚ºä¿è­·è³‡æ–™ï¼Œç›®å‰åƒ…å¾Œç«¯å¯åˆªé™¤æˆå“¡ã€‚");
            };

            const handleRegister = (course, dates, member) => {
                const payload = {
                    memberId: member.id,
                    courseId: course.id,
                    courseTitle: course.title,
                    memberName: member.studentName,
                    selectedDates: dates,
                    totalPrice: course.price * dates.length
                };
                handleServerAction('apiAddRegistration', payload, `å·²å ±åã€Œ${course.title}ã€ï¼Œè«‹å‰å¾€ç¹³è²»ã€‚`);
                setSelectedCourse(null);
            };

            const handleDeleteCategoryWrapper = (cat) => {
                showConfirm("åˆªé™¤åˆ†é¡", `ç¢ºå®šè¦åˆªé™¤ã€Œ${cat}ã€å—ï¼Ÿ`, () => {
                    deleteGlobalCategory(cat);
                    if (newCourseData.categories.includes(cat)) {
                        setNewCourseData(prev => ({ ...prev, categories: prev.categories.filter(c => c !== cat) }));
                    }
                    setConfirmModal(prev => ({ ...prev, isOpen: false }));
                }, true);
            };

            // æ¸²æŸ“é‚è¼¯ï¼šç™»å…¥ç‰†
            if (liffError) return <div className="p-8 text-center text-red-500">LIFF åˆå§‹åŒ–å¤±æ•—: {liffError}</div>;

            if (!isLoading && !currentUser) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm w-full">
                            <img src="https://lihi.cc/dXsA6" alt="Logo" className="w-20 h-20 rounded-xl mx-auto mb-4 shadow-sm" />
                            <h2 className="text-xl font-bold text-gray-800 mb-2">æ­¡è¿ä¾†åˆ°é‹å‹•å³¶</h2>
                            <p className="text-gray-500 mb-6 text-sm">è«‹ç™»å…¥ LINE å¸³è™Ÿä»¥é€²è¡Œå ±å</p>
                            <a href={`https://liff.line.me/${MY_LIFF_ID}`} target="_top" className="w-full bg-[#06C755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-xl shadow-lg shadow-green-100 transition-transform active:scale-95 flex items-center justify-center gap-2 no-underline">
                                <svg viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M21.15 8.92C21.15 4.36 16.42 0.65 10.58 0.65S0 4.36 0 8.92c0 4.06 3.58 7.48 8.35 8.1 0.33 0.07 0.77 0.22 0.88 0.5 0.1 0.23 0.06 0.59-0.03 1.05-0.1 0.44-0.45 1.77-0.58 2.37-0.17 0.81 0.46 0.66 1.15 0.35 0.58-0.27 6.13-4.14 8.7-6.53 2.1-1.68 2.68-3.39 2.68-5.84z" /></svg>ä½¿ç”¨ LINE ç™»å…¥
                            </a>
                        </div>
                    </div>
                );
            }

            // æ¸²æŸ“é‚è¼¯ï¼šä¸»ç•«é¢
            return (
                <div className="bg-gray-50 min-h-screen font-sans text-gray-900 mx-auto relative shadow-2xl overflow-hidden container-fluid">
                
                <LoadingOverlay isOpen={isLoading} message={!currentUser ? "LINE ç™»å…¥ä¸­..." : "è³‡æ–™åŒæ­¥ä¸­..."} />

                <nav className="hidden md:flex bg-white shadow-sm border-b border-gray-200 px-6 py-4 justify-between items-center sticky top-0 z-40">
                    <div className="flex items-center gap-2"><img src="https://lihi.cc/dXsA6" alt="Logo" className="w-10 h-10 rounded-lg object-cover" /><span className="font-bold text-xl text-gray-800">é‹å‹•å³¶</span></div>
                    <div className="flex items-center gap-6">
                        <button onClick={() => setActiveTab('courses')} className={`flex items-center gap-2 font-bold transition-colors ${activeTab === 'courses' ? 'text-green-600' : 'text-gray-500 hover:text-gray-800'}`}><Home className="w-5 h-5" /> èª²ç¨‹åˆ—è¡¨</button>
                        <button onClick={() => setActiveTab('records')} className={`flex items-center gap-2 font-bold transition-colors ${activeTab === 'records' ? 'text-green-600' : 'text-gray-500 hover:text-gray-800'}`}><ClipboardList className="w-5 h-5" /> å ±åç´€éŒ„</button>
                        <button onClick={() => setActiveTab('members')} className={`flex items-center gap-2 font-bold transition-colors ${activeTab === 'members' ? 'text-green-600' : 'text-gray-500 hover:text-gray-800'}`}><Users className="w-5 h-5" /> æœƒå“¡ä¸­å¿ƒ</button>
                        
                        {currentUser && (
                            <div className="flex items-center gap-2 ml-4 bg-gray-100 px-3 py-1 rounded-full">
                                {currentUser.pictureUrl && <img src={currentUser.pictureUrl} className="w-6 h-6 rounded-full" />}
                                <span className="text-xs font-bold text-gray-600 truncate max-w-[100px]">{currentUser.displayName}</span>
                            </div>
                        )}

                        {/* â˜… ä¿®æ”¹ï¼šç®¡ç†å“¡æŒ‰éˆ•é‚è¼¯ */}
                        <button 
                            onClick={() => { if (!isAdmin) setIsAdminAuthOpen(true); }} 
                            className={`ml-2 px-4 py-2 rounded-full text-sm font-bold border transition-all ${isAdmin ? 'bg-black text-white border-black cursor-default' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`}
                        >
                            {isAdmin ? 'ğŸ‘¨â€ğŸ’¼ ç®¡ç†å“¡' : 'ğŸ‘¤ ä¸€èˆ¬ç”¨æˆ¶'}
                        </button>
                    </div>
                </nav>

                <main className="min-h-screen w-full">
                    {activeTab === 'courses' && (
                        <HomeView 
                            courses={courses} allCategories={allCategories} isAdmin={isAdmin}
                            searchTerm={searchTerm} setSearchTerm={setSearchTerm}
                            selectedCategory={selectedCategory} setSelectedCategory={setSelectedCategory}
                            onSelectCourse={setSelectedCourse} onAddCourseClick={() => setIsAddingCourse(true)}
                            onToggleHide={toggleHideCourse} onDeleteCourse={handleDeleteCourse}
                        />
                    )}
                    {activeTab === 'records' && (
                        <RecordsView registrations={registrations} onPayment={handlePayment} goToCourses={() => setActiveTab('courses')} />
                    )}
                    {activeTab === 'members' && (
                        <MembersView 
                            isAdmin={isAdmin} members={members} courses={courses}
                            onDeleteMember={handleDeleteMember} onAddMemberClick={() => setIsAddingMember(true)}
                            onToggleHideCourse={toggleHideCourse} onDeleteCourse={handleDeleteCourse}
                        />
                    )}
                </main>

                <CourseDetailModal course={selectedCourse} onClose={() => setSelectedCourse(null)} isAdmin={isAdmin} onRegister={handleRegister} members={members} onAlert={showAlert} />
                
                <AddCourseModal 
                    isOpen={isAddingCourse} onClose={() => setIsAddingCourse(false)} onSubmit={handleSubmitNewCourse} 
                    data={newCourseData} onChange={(e) => setNewCourseData(prev => ({ ...prev, [e.target.name]: e.target.value }))}
                    onSessionsChange={(newSessions) => setNewCourseData(prev => ({ ...prev, sessions: newSessions }))}
                    availableCategories={allCategories} onAddCategory={addGlobalCategory}
                    onCategoriesChange={(newCats) => setNewCourseData(prev => ({ ...prev, categories: newCats }))}
                    onDeleteCategory={handleDeleteCategoryWrapper}
                />
                
                <AddMemberModal 
                    isOpen={isAddingMember} onClose={() => setIsAddingMember(false)} onSubmit={handleSubmitNewMember} 
                    data={newMemberData} onChange={(e) => setNewMemberData(prev => ({ ...prev, [e.target.name]: e.target.value }))} 
                />

                {/* â˜… æ–°å¢ï¼šç®¡ç†å“¡é©—è­‰è¦–çª—æ”¾åœ¨é€™è£¡ */}
                <AdminAuthModal 
                    isOpen={isAdminAuthOpen} 
                    onClose={() => setIsAdminAuthOpen(false)} 
                    onSubmit={handleAdminAuth} 
                />

                <ConfirmModal {...confirmModal} onClose={() => setConfirmModal(prev => ({ ...prev, isOpen: false }))} />
                <AlertModal {...alertModal} onClose={() => setAlertModal(prev => ({ ...prev, isOpen: false }))} />

                <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-between items-center z-40 max-w-md mx-auto w-full">
                    <button onClick={() => setActiveTab('courses')} className={`flex flex-col items-center gap-1 ${activeTab === 'courses' ? 'text-green-600' : 'text-gray-400'}`}><Home className="w-6 h-6" /><span className="text-[10px] font-medium">èª²ç¨‹</span></button>
                    <button onClick={() => setActiveTab('records')} className={`flex flex-col items-center gap-1 ${activeTab === 'records' ? 'text-green-600' : 'text-gray-400'}`}><ClipboardList className="w-6 h-6" /><span className="text-[10px] font-medium">å ±åç´€éŒ„</span></button>
                    <button onClick={() => setActiveTab('members')} className={`flex flex-col items-center gap-1 ${activeTab === 'members' ? 'text-green-600' : 'text-gray-400'}`}><Users className="w-6 h-6" /><span className="text-[10px] font-medium">æˆå“¡</span></button>
                </nav>
                
                <div className="md:hidden fixed top-4 right-4 z-50 flex gap-2">
                    {currentUser && <img src={currentUser.pictureUrl} className="w-8 h-8 rounded-full border border-white shadow-sm" />}
                    <button onClick={() => { if (!isAdmin) setIsAdminAuthOpen(true); }} className={`text-white text-xs px-3 py-1.5 rounded-full shadow-lg backdrop-blur-sm border border-white/20 transition-all active:scale-95 ${isAdmin ? 'bg-black/80 cursor-default' : 'bg-black/60 hover:bg-black/80'}`}>
                        {isAdmin ? 'ğŸ‘¨â€ğŸ’¼' : 'ğŸ‘¤'}
                    </button>
                </div>
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>

